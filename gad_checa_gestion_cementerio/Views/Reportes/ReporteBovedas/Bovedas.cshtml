@model gad_checa_gestion_cementerio.Models.Views.FiltroBovedasViewModel

@{
    ViewData["Title"] = "Reporte de Bóvedas";
    Layout = "~/Views/Reportes/_ReportesLayout.cshtml";
}
<div class="card">

    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
            <h4 class="card-title mb-2">@ViewData["Title"]</h4>
            <p class="text-muted">
                Visualice y gestione las bóvedas del cementerio.
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center mt-3 mt-md-0 flex-nowrap">
            <!-- Filtros -->
            <form method="get" asp-action="Bovedas" class="d-flex gap-2 align-items-center flex-nowrap">
                <!-- Tipo de bloque -->
                <select name="tipoBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Tipo de Bóveda --</option>
                    @foreach (var tipo in Model.TiposDisponibles)
                    {
                        @if (Model.TipoBloque == tipo)
                        {
                            <option value="@tipo" selected>@tipo</option>
                        }
                        else
                        {
                            <option value="@tipo">@tipo</option>
                        }
                    }
                </select>

                <!-- Nombre del bloque -->
                <select name="nombreBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Bloque --</option>
                    @foreach (var bloque in Model.BloquesDisponibles)
                    {
                        @if (Model.NombreBloque == bloque)
                        {
                            <option value="@bloque" selected>@bloque</option>
                        }
                        else
                        {
                            <option value="@bloque">@bloque</option>
                        }
                    }
                </select>

                <!-- Botón Filtrar -->
                <button type="submit" class="btn btn-success btn-sm d-flex align-items-center">
                    <i class="ti ti-filter me-1"></i> Filtrar
                </button>
            </form>

            <!-- Botón PDF -->
            <form method="get" asp-action="BovedasPdf">
                <input type="hidden" name="tipoBloque" value="@Model.TipoBloque" />
                <input type="hidden" name="nombreBloque" value="@Model.NombreBloque" />
                <button type="submit" class="btn btn-primary btn-sm ">
                    <i class="ti ti-download"></i> <span class="no-wrap">Generar PDF</span><span class="no-wrap">
                    </span>
                </button>
            </form>
        </div>
    </div>


    <div class="min-h-screen bg-white p-6 flex flex-col items-center">

        @{
            var totalOcupadas = Model.BovedasOcupadas + Model.NichosOcupados;
            var totalLibres = Model.BovedasDisponibles + Model.NichosDisponibles;
            var porcentajeOcupacion = Model.TotalGeneral > 0 ? Math.Round((double)totalOcupadas / Model.TotalGeneral * 100,
            1) : 0;
            var porcentajeDisponible = Model.TotalGeneral > 0 ? Math.Round((double)totalLibres / Model.TotalGeneral * 100,
            1) : 0;
            var porcentajeCaducar = totalOcupadas > 0 ? Math.Round((double)Model.BovedasPorCaducar / totalOcupadas * 100, 1)
            : 0;

            var ocupacionBovedas = Model.TotalBovedas > 0 ? Math.Round((double)Model.BovedasOcupadas / Model.TotalBovedas *
            100, 1) : 0;
            var ocupacionNichos = Model.TotalNichos > 0 ? Math.Round((double)Model.NichosOcupados / Model.TotalNichos * 100,
            1) : 0;

            var disponibilidadBovedas = Model.TotalBovedas > 0 ? Math.Round((double)Model.BovedasDisponibles /
            Model.TotalBovedas * 100, 1) : 0;
            var disponibilidadNichos = Model.TotalNichos > 0 ? Math.Round((double)Model.NichosDisponibles /
            Model.TotalNichos * 100, 1) : 0;

            var porcentajeBovedas = Model.TotalGeneral > 0 ? Math.Round((double)Model.TotalBovedas / Model.TotalGeneral *
            100, 1) : 0;
            var porcentajeNichos = Model.TotalGeneral > 0 ? Math.Round((double)Model.TotalNichos / Model.TotalGeneral * 100,
            1) : 0;
        }

        <!-- Estadísticas Resumen -->
        <div class="row mb-4 w-100">
            <!-- Resumen General -->
            <div class="col-12 mb-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="ti ti-chart-pie me-2"></i>Resumen General del Cementerio</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="ti ti-sum fs-3 text-primary mb-2"></i>
                                    <div class="fw-bold text-primary fs-2">@Model.TotalGeneral</div>
                                    <small class="text-muted d-block">Total Espacios</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                    <i class="ti ti-users fs-3 text-success mb-2"></i>
                                    <div class="fw-bold text-success fs-2">@totalOcupadas</div>
                                    <small class="text-muted d-block">Ocupadas</small>
                                    <small class="text-success fw-bold">@porcentajeOcupacion%</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-secondary bg-opacity-10 rounded">
                                    <i class="ti ti-door-enter fs-3 text-secondary mb-2"></i>
                                    <div class="fw-bold text-secondary fs-2">@totalLibres</div>
                                    <small class="text-muted d-block">Disponibles</small>
                                    <small class="text-secondary fw-bold">@porcentajeDisponible%</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                                    <i class="ti ti-alert-triangle fs-3 text-warning mb-2"></i>
                                    <div class="fw-bold text-warning fs-2">@Model.BovedasPorCaducar</div>
                                    <small class="text-muted d-block">Por Caducar</small>
                                    <small class="text-warning fw-bold">@porcentajeCaducar% de ocupadas</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                    <i class="ti ti-building fs-3 text-info mb-2"></i>
                                    <div class="fw-bold text-info fs-2">@Model.TotalBovedas</div>
                                    <small class="text-muted d-block">Total Bóvedas</small>
                                    <small class="text-info fw-bold">@porcentajeBovedas% del total</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                    <i class="ti ti-layout-grid fs-3 text-info mb-2"></i>
                                    <div class="fw-bold text-info fs-2">@Model.TotalNichos</div>
                                    <small class="text-muted d-block">Total Nichos</small>
                                    <small class="text-info fw-bold">@porcentajeNichos% del total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desglose por Tipo -->
            <div class="col-md-6 mb-3">
                <div class="card border-success shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="ti ti-building me-2"></i>Bóvedas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                    <i class="ti ti-check-circle fs-2 text-success mb-2"></i>
                                    <div class="fw-bold text-success fs-1">@Model.BovedasOcupadas</div>
                                    <small class="text-muted d-block">Ocupadas</small>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                            style="width: @ocupacionBovedas%" aria-valuenow="@ocupacionBovedas"
                                            aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-success fw-bold">@ocupacionBovedas% ocupación</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="ti ti-circle-dashed fs-2 text-muted mb-2"></i>
                                    <div class="fw-bold text-secondary fs-1">@Model.BovedasDisponibles</div>
                                    <small class="text-muted d-block">Disponibles</small>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-secondary" role="progressbar"
                                            style="width: @disponibilidadBovedas%"
                                            aria-valuenow="@disponibilidadBovedas" aria-valuemin="0"
                                            aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-secondary fw-bold">@disponibilidadBovedas% libre</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="badge bg-success-subtle text-success fs-6 px-3 py-2">
                                Total: @Model.TotalBovedas bóvedas
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card border-primary shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="ti ti-layout-grid me-2"></i>Nichos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                    <i class="ti ti-check-circle fs-2 text-primary mb-2"></i>
                                    <div class="fw-bold text-primary fs-1">@Model.NichosOcupados</div>
                                    <small class="text-muted d-block">Ocupados</small>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                            style="width: @ocupacionNichos%" aria-valuenow="@ocupacionNichos"
                                            aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-primary fw-bold">@ocupacionNichos% ocupación</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="ti ti-circle-dashed fs-2 text-muted mb-2"></i>
                                    <div class="fw-bold text-secondary fs-1">@Model.NichosDisponibles</div>
                                    <small class="text-muted d-block">Disponibles</small>
                                    <div class="progress mt-2" style="height: 8px;">
                                        <div class="progress-bar bg-secondary" role="progressbar"
                                            style="width: @disponibilidadNichos%" aria-valuenow="@disponibilidadNichos"
                                            aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-secondary fw-bold">@disponibilidadNichos% libre</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <div class="badge bg-primary-subtle text-primary fs-6 px-3 py-2">
                                Total: @Model.TotalNichos nichos
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0">
                <thead class="table-secondary small">
                    <tr>
                        <th scope="col">Bóveda</th>
                        <th scope="col">Piso</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Bloque</th>
                        <th scope="col">Tipo</th>
                        <th scope="col">Contrato</th>
                        <th scope="col">Duración</th>
                        <th scope="col">Propietario</th>
                        <th scope="col">Difunto</th>
                    </tr>
                </thead>
                <tbody class="small">
                    @foreach (var item in Model.Bovedas)
                    {
                        <tr>
                            <td>@item.NumeroBoveda</td>
                            <td>@item.NumeroPiso</td>
                            <td>
                                <span class="@item.GetCssClassEstado()">
                                    @item.GetEstadoCalculado()
                                    @if (!string.IsNullOrEmpty(item.GetInfoAdicionalEstado()))
                                    {
                                        <br />

                                        <small class="text-muted">@item.GetInfoAdicionalEstado()</small>
                                    }
                                </span>
                            </td>
                            <td>@item.NombreBloque</td>
                            <td>@item.TipoBloque</td>
                            <td>
                                @if (item.NumeroSecuencialContrato != null)
                                {
                                    <div>
                                        <strong>@item.NumeroSecuencialContrato</strong><br />
                                        <small class="text-muted">
                                            @item.FechaInicioContrato?.ToString("dd/MM/yyyy") -
                                            @item.FechaFinContrato?.ToString("dd/MM/yyyy")
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin contrato</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.GetDuracionFormateada()))
                                {
                                    @item.GetDuracionFormateada()
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (item.NombrePropietario != null)
                                {
                                    <div>
                                        <strong>@item.NombrePropietario</strong><br />
                                        <small class="text-muted">CI: @item.CedulaPropietario</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin propietario</span>
                                }
                            </td>
                            <td>
                                @if (item.NombresDifunto != null)
                                {
                                    <div>
                                        <strong>@item.NombresDifunto @item.ApellidosDifunto</strong><br />
                                        <small class="text-muted">
                                            @if (item.FechaFallecimiento != null)
                                            {
                                                @("Fallecido: " + item.FechaFallecimiento.Value.ToString("dd/MM/yyyy"))
                                            }
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin difunto</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>