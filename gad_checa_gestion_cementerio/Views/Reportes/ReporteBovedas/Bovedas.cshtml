@model gad_checa_gestion_cementerio.Models.Views.FiltroBovedasViewModel

@{
    ViewData["Title"] = "Reporte de Bóvedas";
    Layout = "~/Views/Reportes/_ReportesLayout.cshtml";
}
<div class="card">

    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
            <h4 class="card-title mb-2">@ViewData["Title"]</h4>
            <p class="text-muted">
                Visualice y gestione las bóvedas del cementerio.
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center mt-3 mt-md-0 flex-nowrap">
            <!-- Filtros -->
            <form method="get" asp-action="Bovedas" class="d-flex gap-2 align-items-center flex-nowrap">
                <!-- Tipo de bloque -->
                <select name="tipoBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Tipo de Bóveda --</option>
                    @foreach (var tipo in Model.TiposDisponibles)
                    {
                        <option value="@tipo" @(Model.TipoBloque == tipo ? "selected" : "")>@tipo</option>
                    }
                </select>

                <!-- Nombre del bloque -->
                <select name="nombreBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Bloque --</option>
                    @foreach (var bloque in Model.BloquesDisponibles)
                    {
                        <option value="@bloque" @(Model.NombreBloque == bloque ? "selected" : "")>
                            @bloque
                        </option>
                    }
                </select>

                <!-- Botón Filtrar -->
                <button type="submit" class="btn btn-success btn-sm d-flex align-items-center">
                    <i class="ti ti-filter me-1"></i> Filtrar
                </button>
            </form>

            <!-- Botón PDF -->
            <form method="get" asp-action="BovedasPdf">
                <input type="hidden" name="tipoBloque" value="@Model.TipoBloque ?? "" " />
                <input type="hidden" name="nombreBloque" value="@Model.NombreBloque ?? "" " />
                <button type="submit" class="btn btn-primary btn-sm ">
                    <i class="ti ti-download"></i> <span class="no-wrap">Generar PDF</span>
                </button>
            </form>
        </div>
    </div>

    <div class="min-h-screen bg-white p-6 flex flex-col items-center">

        <!-- Estadísticas Resumen -->
        <div class="row mb-4 w-100">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="row">
                            @{
                                Func<string, bool> esBoveda = (tipo) => {
                                    var tipoUpper = tipo?.ToUpper() ?? "";
                                    return tipoUpper.Contains("BOVEDA") || tipoUpper.Contains("BÓVEDA");
                                };

                                Func<string, bool> esNicho = (tipo) => {
                                    var tipoUpper = tipo?.ToUpper() ?? "";
                                    return tipoUpper.Contains("NICHO");
                                };

                                var totalBovedas = Model.Bovedas.Where(b => esBoveda(b.TipoBloque)).Count();
                                var totalNichos = Model.Bovedas.Where(b => esNicho(b.TipoBloque)).Count();
                                var totalOcupadas = Model.Bovedas.Count(b => b.TieneContratoActivo());
                                var totalPorCaducar = Model.Bovedas.Count(b => b.TieneContratoPorCaducar());
                                var totalLibres = Model.Bovedas.Count(b => !b.TieneContratoActivo() && !b.TieneContratoPorCaducar());
                                var totalGeneral = Model.Bovedas.Count();
                            }
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-primary fs-4">@totalGeneral</div>
                                    <small class="text-muted">Total General</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-info fs-4">@totalBovedas</div>
                                    <small class="text-muted">Bóvedas</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-info fs-4">@totalNichos</div>
                                    <small class="text-muted">Nichos</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-success fs-4">@totalOcupadas</div>
                                    <small class="text-muted">Ocupadas</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-warning fs-4">@totalPorCaducar</div>
                                    <small class="text-muted">Por Caducar</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-secondary fs-4">@totalLibres</div>
                                    <small class="text-muted">Libres</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0">
                <thead class="table-secondary small">
                    <tr>
                        <th scope="col">Bóveda</th>
                        <th scope="col">Piso</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Bloque</th>
                        <th scope="col">Tipo</th>
                        <th scope="col">Contrato</th>
                        <th scope="col">Duración</th>
                        <th scope="col">Propietario</th>
                        <th scope="col">Difunto</th>
                    </tr>
                </thead>
                <tbody class="small">
                    @foreach (var item in Model.Bovedas)
                    {
                        <tr>
                            <td>@item.NumeroBoveda</td>
                            <td>@item.NumeroPiso</td>
                            <td>
                                <span class="@item.GetCssClassEstado()">
                                    @item.GetEstadoCalculado()
                                    @if (!string.IsNullOrEmpty(item.GetInfoAdicionalEstado()))
                                    {
                                        <br />
                                        <small class="text-muted">@item.GetInfoAdicionalEstado()</small>
                                    }
                                </span>
                            </td>
                            <td>@item.NombreBloque</td>
                            <td>@item.TipoBloque</td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.NumeroSecuencialContrato))
                                {
                                    <div>
                                        <strong>@item.NumeroSecuencialContrato</strong><br />
                                        <small class="text-muted">
                                            @(item.FechaInicioContrato?.ToString("dd/MM/yyyy") ?? "-") -
                                            @(item.FechaFinContrato?.ToString("dd/MM/yyyy") ?? "-")
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin contrato</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.GetDuracionFormateada()))
                                {
                                    @item.GetDuracionFormateada()
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.NombrePropietario))
                                {
                                    <div>
                                        <strong>@item.NombrePropietario</strong><br />
                                        <small class="text-muted">CI: @item.CedulaPropietario</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin propietario</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.NombresDifunto))
                                {
                                    <div>
                                        <strong>@item.NombresDifunto @item.ApellidosDifunto</strong><br />
                                        <small class="text-muted">
                                            @if (item.FechaFallecimiento != null)
                                            {
                                                @("Fallecido: " + item.FechaFallecimiento.Value.ToString("dd/MM/yyyy"))
                                            }
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin difunto</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>
