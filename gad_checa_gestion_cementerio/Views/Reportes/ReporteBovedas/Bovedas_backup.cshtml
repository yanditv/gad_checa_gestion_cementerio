@model gad_checa_gestion_cementerio.Models.Views.FiltroBovedasViewModel

@{
    ViewData["Title"] = "Reporte de B贸vedas";
    Layout = "~/Views/Reportes/_ReportesLayout.cshtml";
}
<div class="card">

    <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
            <h4 class="card-title mb-2">@ViewData["Title"]</h4>
            <p class="text-muted">
                Visualice y gestione las b贸vedas del cementerio.
            </p>
        </div>
        <div class="d-flex gap-2 align-items-center mt-3 mt-md-0 flex-nowrap">
            <!-- Filtros -->
            <form method="get" asp-action="Bovedas" class="d-flex gap-2 align-items-center flex-nowrap">
                <!-- Tipo de bloque -->
                <select name="tipoBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Tipo de B贸veda --</option>
                    @foreach (var tipo in Model.TiposDisponibles)
                    {
                        @if (Model.TipoBloque == tipo)
                        {
                            <option value="@tipo" selected>@tipo</option>
                        }
                        else
                        {
                            <option value="@tipo">@tipo</option>
                        }
                    }
                </select>

                <!-- Nombre del bloque -->
                <select name="nombreBloque" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">-- Bloque --</option>
                    @foreach (var bloque in Model.BloquesDisponibles)
                    {
                        @if (Model.NombreBloque == bloque)
                        {
                            <option value="@bloque" selected>@bloque</option>
                        }
                        else
                        {
                            <option value="@bloque">@bloque</option>
                        }
                    }
                </select>

                <!-- Bot贸n Filtrar -->
                <button type="submit" class="btn btn-success btn-sm d-flex align-items-center">
                    <i class="ti ti-filter me-1"></i> Filtrar
                </button>
            </form>

            <!-- Bot贸n PDF -->
            <form method="get" asp-action="BovedasPdf">
                <input type="hidden" name="tipoBloque" value="@Model.TipoBloque" />
                <input type="hidden" name="nombreBloque" value="@Model.NombreBloque" />
                <button type="submit" class="btn btn-primary btn-sm ">
                    <i class="ti ti-download"></i> <span class="no-wrap">Generar PDF</span><span class="no-wrap">
                    </span>
                </button>
            </form>
        </div>
    </div>


    <div class="min-h-screen bg-white p-6 flex flex-col items-center">

        <!-- Estad铆sticas Resumen -->
        <div class="row mb-4 w-100">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary mb-3"> Estad铆sticas Generales</h6>
                        
                        <!-- Debug Info Temporal -->
                        @{
                            var tiposUnicos = Model.Bovedas.Select(b => b.TipoBloque).Distinct().ToList();
                        }
                        @if (tiposUnicos.Any())
                        {
                            <div class="alert alert-info mb-3">
                                <strong>Debug - Tipos encontrados:</strong> @string.Join(", ", tiposUnicos) 
                                <br />
                                <strong>Total registros:</strong> @Model.Bovedas.Count()
                                <br />
                                <strong>Detalle por tipo:</strong>
                                @foreach (var tipo in tiposUnicos)
                                {
                                    var count = Model.Bovedas.Count(b => b.TipoBloque == tipo);
                                    <span class="badge bg-secondary me-1">@tipo: @count</span>
                                }
                            </div>
                        }
                        
                        <div class="row">
                            @{
                                // Funci贸n auxiliar para determinar si es b贸veda o nicho
                                Func<string, bool> esBoveda = (tipo) => {
                                    var tipoUpper = tipo?.ToUpper() ?? "";
                                    return tipoUpper.Contains("BOVEDA") || tipoUpper.Contains("BVEDA");
                                };
                                
                                Func<string, bool> esNicho = (tipo) => {
                                    var tipoUpper = tipo?.ToUpper() ?? "";
                                    return tipoUpper.Contains("NICHO");
                                };

                                var totalBovedas = Model.Bovedas.Where(b => esBoveda(b.TipoBloque)).Count();
                                var totalNichos = Model.Bovedas.Where(b => esNicho(b.TipoBloque)).Count();
                                var totalOcupadas = Model.Bovedas.Count(b => b.TieneContratoActivo());
                                var totalPorCaducar = Model.Bovedas.Count(b => b.TieneContratoPorCaducar());
                                var totalLibres = Model.Bovedas.Count(b => !b.TieneContratoActivo() &&
                                !b.TieneContratoPorCaducar());
                                var totalGeneral = Model.Bovedas.Count();
                            }
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-primary fs-4">@totalGeneral</div>
                                    <small class="text-muted">Total General</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-info fs-4">@totalBovedas</div>
                                    <small class="text-muted">B贸vedas</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-info fs-4">@totalNichos</div>
                                    <small class="text-muted">Nichos</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-success fs-4">@totalOcupadas</div>
                                    <small class="text-muted">Ocupadas</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-warning fs-4">@totalPorCaducar</div>
                                    <small class="text-muted">Por Caducar</small>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-4 col-6">
                                <div class="text-center">
                                    <div class="fw-bold text-secondary fs-4">@totalLibres</div>
                                    <small class="text-muted">Libres</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover mb-0">
                <thead class="table-secondary small">
                    <tr>
                        <th scope="col">B贸veda</th>
                        <th scope="col">Piso</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Bloque</th>
                        <th scope="col">Tipo</th>
                        <th scope="col">Contrato</th>
                        <th scope="col">Duraci贸n</th>
                        <th scope="col">Propietario</th>
                        <th scope="col">Difunto</th>
                    </tr>
                </thead>
                <tbody class="small">
                    @foreach (var item in Model.Bovedas)
                    {
                        <tr>
                            <td>@item.NumeroBoveda</td>
                            <td>@item.NumeroPiso</td>
                            <td>
                                <span class="@item.GetCssClassEstado()">
                                    @item.GetEstadoCalculado()
                                    @if (!string.IsNullOrEmpty(item.GetInfoAdicionalEstado()))
                                    {
                                        <br />
                                
                                        <small class="text-muted">@item.GetInfoAdicionalEstado()</small>
                                    }
                                </span>
                            </td>
                            <td>@item.NombreBloque</td>
                            <td>@item.TipoBloque</td>
                            <td>
                                @if (item.NumeroSecuencialContrato != null)
                                {
                                    <div>
                                        <strong>@item.NumeroSecuencialContrato</strong><br />
                                        <small class="text-muted">
                                            @item.FechaInicioContrato?.ToString("dd/MM/yyyy") -
                                            @item.FechaFinContrato?.ToString("dd/MM/yyyy")
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin contrato</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.GetDuracionFormateada()))
                                {
                                    @item.GetDuracionFormateada()
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (item.NombrePropietario != null)
                                {
                                    <div>
                                        <strong>@item.NombrePropietario</strong><br />
                                        <small class="text-muted">CI: @item.CedulaPropietario</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin propietario</span>
                                }
                            </td>
                            <td>
                                @if (item.NombresDifunto != null)
                                {
                                    <div>
                                        <strong>@item.NombresDifunto @item.ApellidosDifunto</strong><br />
                                        <small class="text-muted">
                                            @if (item.FechaFallecimiento != null)
                                            {
                                                @("Fallecido: " + item.FechaFallecimiento.Value.ToString("dd/MM/yyyy"))
                                            }
                                        </small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin difunto</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>
