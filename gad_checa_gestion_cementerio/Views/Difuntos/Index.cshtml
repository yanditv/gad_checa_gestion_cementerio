@model gad_checa_gestion_cementerio.Models.Listas.DifuntoPaginadaViewModel

@{
    ViewData["Title"] = "Difuntos";
}

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex align-items-center">
            <i class="fas fa-users me-2"></i>
            <h4 class="card-title mb-0">@ViewData["Title"]</h4>
        </div>
        <p class="mt-2 mb-0">
            Visualice y gestione los registros de difuntos. Utilice los filtros para encontrar información específica.
        </p>
    </div>

    <div class="card-body">
        <!-- Barra de Herramientas -->
        <div class="mb-4">
            <!-- Filtros -->
            <form id="searchForm" asp-action="Index" method="get">
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="filtroNumeroIdentificacion" class="form-label fw-bold">
                            <i class="fas fa-id-card me-1"></i>Número de identificación
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="filtroNumeroIdentificacion" name="filtroNumeroIdentificacion" value="@Model.FiltroNumeroIdentificacion"
                                placeholder="Buscar por número..."
                                class="form-control" autocomplete="off" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroNombres" class="form-label fw-bold">
                            <i class="fas fa-user me-1"></i>Nombres
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="filtroNombres" name="filtroNombres" value="@Model.FiltroNombres"
                                placeholder="Buscar por nombres..."
                                class="form-control" autocomplete="off" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroApellidos" class="form-label fw-bold">
                            <i class="fas fa-user-tag me-1"></i>Apellidos
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="filtroApellidos" name="filtroApellidos" value="@Model.FiltroApellidos"
                                placeholder="Buscar por apellidos..."
                                class="form-control" autocomplete="off" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="filtroBoveda" class="form-label fw-bold">
                            <i class="fas fa-building me-1"></i>Bóveda/Contrato
                        </label>
                        <div class="input-group input-group-sm">
                            <input type="text" id="filtroBoveda" name="filtroBoveda" value="@Model.FiltroBoveda"
                                placeholder="Buscar por bóveda..."
                                class="form-control" autocomplete="off" />
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" id="clearFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Limpiar filtros
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Difuntos -->
        <div id="resultsContainer" class="table-responsive">
            @await Html.PartialAsync("_DifuntosConPaginacion", Model)
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchForm = document.getElementById('searchForm');
            const resultsContainer = document.getElementById('resultsContainer');
            const clearFiltersBtn = document.getElementById('clearFilters');

            let searchTimeout = null;
            let isSearching = false;

            // Función para realizar la búsqueda
            async function performSearch(url = null) {
                if (isSearching) return;

                isSearching = true;

                try {
                    let requestUrl = url;
                    if (!requestUrl) {
                        const formData = new FormData(searchForm);
                        const queryString = new URLSearchParams(formData).toString();
                        requestUrl = `${searchForm.action}?${queryString}`;
                    }

                    const response = await fetch(requestUrl, {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) throw new Error('Error en la búsqueda');

                    const html = await response.text();

                    // Actualizar el contenedor de resultados con la vista parcial devuelta
                    resultsContainer.innerHTML = html;

                    // Agregar event listeners a los nuevos enlaces de paginación
                    attachPaginationHandlers();

                    // Actualizar la URL sin recargar la página
                    const newUrl = new URL(requestUrl);
                    window.history.pushState({}, '', newUrl);

                } catch (error) {
                    console.error('Error:', error);
                    // Mostrar mensaje de error al usuario
                    resultsContainer.innerHTML = `
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error al realizar la búsqueda. Por favor, intente nuevamente.
                            </div>
                        `;
                } finally {
                    isSearching = false;
                }
            }

            // Función para agregar event listeners a los enlaces de paginación
            function attachPaginationHandlers() {
                const paginationLinks = resultsContainer.querySelectorAll('.pagination-link');
                paginationLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (!this.classList.contains('disabled')) {
                            performSearch(this.href);
                        }
                    });
                });
            }

            // Función para manejar cambios en los inputs
            function handleInputChange() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(performSearch, 500);
            }

            // Agregar event listeners a todos los inputs de filtro
            const filterInputs = searchForm.querySelectorAll('input[type="text"]');
            filterInputs.forEach(input => {
                input.addEventListener('input', handleInputChange);
            });

            // Prevenir el envío del formulario tradicional
            searchForm.addEventListener('submit', function (e) {
                e.preventDefault();
                performSearch();
            });

            // Función para limpiar filtros
            clearFiltersBtn.addEventListener('click', function () {
                filterInputs.forEach(input => {
                    input.value = '';
                });
                performSearch();
            });

            // Inicializar los event handlers de paginación
            attachPaginationHandlers();

            // Manejar la navegación del historial
            window.addEventListener('popstate', function () {
                // Recargar la página para obtener los parámetros correctos
                window.location.reload();
            });
        });
    </script>
}
