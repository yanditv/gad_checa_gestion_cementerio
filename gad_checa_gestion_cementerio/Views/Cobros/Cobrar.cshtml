@model gad_checa_gestion_cementerio.Models.PagoModel
@using gad_checa_gestion_cementerio.Models
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Crear Pago";
    var contrato = ViewBag.Contrato as gad_checa_gestion_cementerio.Models.ContratoModel;
    var responsables = ViewBag.Responsables as List<SelectListItem>;
    var responsablePrincipal = responsables?.FirstOrDefault();
}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-light border-0 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span class="me-3"><i class="ti ti-cash-banknote text-primary fs-3"></i></span>
                <div>
                    <h4 class="mb-1 text-dark">Registrar Pago</h4>
                    <p class="mb-0 text-muted small">Registre los detalles del pago y verifique la información del
                        contrato.</p>
                </div>
            </div>
            <div>
                <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                    <i class="ti ti-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Resumen del Contrato -->
        @if (contrato != null)
        {
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card border-0 bg-light-subtle shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-file-description text-primary fs-4 me-2"></i>
                                <div>
                                    <div class="text-muted small">Contrato</div>
                                    <span class="fw-bold">#@contrato.NumeroSecuencial</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-user text-primary me-2"></i>
                                <div>
                                    <div class="text-muted small">Difunto</div>
                                    <span class="fw-bold">@contrato.Difunto?.Nombres @contrato.Difunto?.Apellidos</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-building-bank text-primary me-2"></i>
                                <div>
                                    <div class="text-muted small">Bóveda</div>
                                    <span class="fw-bold">@contrato.Boveda?.NumeroSecuencial</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-currency-dollar text-primary me-2"></i>
                                <div>
                                    <div class="text-muted small">Monto Total</div>
                                    <span class="fw-bold">$@contrato.MontoTotal.ToString("N2")</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="ti ti-list-check text-primary me-2"></i>
                                <div>
                                    <div class="text-muted small">Cuotas Pendientes</div>
                                    <span class="fw-bold">@contrato.Cuotas.Count(c => !c.Pagada)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 bg-info-subtle shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-user-star text-info fs-4 me-2"></i>
                                <div>
                                    <div class="text-muted small">Responsable Principal</div>
                                    <span class="fw-bold">@responsablePrincipal?.Text</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-id text-info me-2"></i>
                                <div>
                                    <div class="text-muted small">Identificación</div>
                                    <span
                                        class="fw-bold">@contrato.Responsables?.FirstOrDefault()?.NumeroIdentificacion</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-mail text-info me-2"></i>
                                <div>
                                    <div class="text-muted small">Email</div>
                                    <span class="fw-bold">@contrato.Responsables?.FirstOrDefault()?.Email</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="ti ti-phone text-info me-2"></i>
                                <div>
                                    <div class="text-muted small">Teléfono</div>
                                    <span class="fw-bold">@contrato.Responsables?.FirstOrDefault()?.Telefono</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 bg-success-subtle shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-calendar-event text-success fs-4 me-2"></i>
                                <div>
                                    <div class="text-muted small">Fecha de Inicio</div>
                                    <span class="fw-bold">@contrato.FechaInicio.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="ti ti-calendar-x text-success me-2"></i>
                                <div>
                                    <div class="text-muted small">Fecha de Vencimiento</div>
                                    <span class="fw-bold">@contrato.FechaFin?.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="ti ti-file-invoice text-success me-2"></i>
                                <div>
                                    <div class="text-muted small">Estado</div>
                                    <span class="fw-bold">@(contrato.Estado ? "Activo" : "Inactivo")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        <form asp-action="Cobrar" method="post">
            @if (!ViewData.ModelState.IsValid && ViewData.ModelState.Values.Any(v => v.Errors.Count > 0))
            {
                <div class="alert alert-danger">
                    <ul class="mb-0">
                        @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    </ul>
                </div>
            }
            <div class="row g-3">
                <!-- Información del Pago -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0 py-2">
                            <h6 class="mb-0"><i class="ti ti-info-circle me-2 text-primary"></i>Información del Pago
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="TipoPago" class="form-label">Tipo de Pago</label>
                                <select asp-for="TipoPago" class="form-select" asp-items="ViewBag.TiposPago">
                                    <option value="">Seleccione un tipo de pago</option>
                                </select>
                                <span asp-validation-for="TipoPago" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Número de Comprobante</label>
                                <input name="NumeroComprobante" class="form-control"
                                    placeholder="Ingrese el número de comprobante" />
                                <span asp-validation-for="NumeroComprobante" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="Monto" class="form-label">Monto</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-currency-dollar"></i></span>
                                    <input asp-for="Monto" class="form-control" placeholder="0.00" />
                                </div>
                                <span asp-validation-for="Monto" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="FechaPago" class="form-label">Fecha de Pago</label>
                                <input asp-for="FechaPago" type="date" class="form-control" />
                                <span asp-validation-for="FechaPago" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Responsable del Pago -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0 py-2">
                            <h6 class="mb-0"><i class="ti ti-user me-2 text-primary"></i>Responsable del Pago</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="PersonaPagoId" class="form-label">Seleccione el responsable</label>
                                <select id="PersonaPagoId" name="PersonaPagoId" class="form-control select2">
                                    <option value="">-- Buscar persona --</option>
                                    @foreach (var persona in responsables)
                                    {
                                        var selected = Model.PersonaPagoId.ToString() == persona.Value ||
                                        (Model.PersonaPagoId == 0 && persona.Equals(responsablePrincipal)) ?
                                        "selected=\"selected\"" : "";
                                        @Html.Raw($"<option value=\"{persona.Value}\" {selected}>{persona.Text}</option>")
                                    }
                                </select>
                                <span asp-validation-for="PersonaPagoId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Cuotas a Pagar -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light border-0 py-2">
                            <h6 class="mb-0"><i class="ti ti-list me-2 text-primary"></i>Cuotas a Pagar</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0" style="width: 50px;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                                </div>
                                            </th>
                                            <th class="border-0"><i
                                                    class="ti ti-calendar-event me-1 text-primary"></i>Fecha de
                                                Vencimiento</th>
                                            <th class="border-0"><i
                                                    class="ti ti-currency-dollar me-1 text-primary"></i>Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Cuotas.Count; i++)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input cuota-checkbox"
                                                            name="CuotasSeleccionadas" value="@Model.Cuotas[i].Id" />
                                                    </div>
                                                </td>
                                                <td>@Model.Cuotas[i].FechaVencimiento.ToString("dd/MM/yyyy")</td>
                                                <td class="fw-bold"><span
                                                        class="badge bg-light text-dark">@Model.Cuotas[i].Monto.ToString("C")</span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Botón de Envío -->
                <div class="col-12 text-end mt-4">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="ti ti-device-floppy me-1"></i>Registrar Pago
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
@* Modal para crear nueva persona *@
<div class="modal fade" id="modalNuevaPersona" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    <i class="ti ti-user-plus me-2"></i>Crear Nueva Persona
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalPersonaContent">
                <!-- Aquí se carga el formulario de persona -->
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // Inicializar Select2
            const select = $('.select2');
            select.select2({
                placeholder: "Buscar persona...",
                allowClear: true,
                width: '100%',
                language: {
                    noResults: function () {
                        return `
                                                    <div class="text-center py-2">
                                                        <span class="d-block mb-2 text-muted">No se encontraron personas</span>
                                                        <button type="button" onclick="abrirModalCrearPersona()" class="btn btn-outline-primary btn-sm">
                                                            <i class="ti ti-plus me-1"></i>Crear nueva persona
                                                        </button>
                                                    </div>
                                                `;
                    }
                },
                escapeMarkup: function (markup) { return markup; }
            });
            // Estilizar Select2
            function aplicarEstiloBootstrap() {
                $('.select2-container--default .select2-selection--single')
                    .addClass('form-control form-control-md')
                    .removeClass('select2-selection--single');
                $('.select2-container--open .select2-search__field')
                    .addClass('form-control form-control-md');
                $('.select2-selection__clear')
                    .removeClass('select2-selection__clear')
                    .addClass('btn-close position-absolute top-50 translate-middle-y end-0 me-2');
            }
            select.on('select2:open', function () {
                setTimeout(aplicarEstiloBootstrap, 0);
            });
            aplicarEstiloBootstrap();
            // Manejar selección de todas las cuotas
            $('#selectAll').change(function () {
                $('.cuota-checkbox').prop('checked', $(this).prop('checked'));
            });
            $('.cuota-checkbox').change(function () {
                if (!$(this).prop('checked')) {
                    $('#selectAll').prop('checked', false);
                } else {
                    let allChecked = true;
                    $('.cuota-checkbox').each(function () {
                        if (!$(this).prop('checked')) {
                            allChecked = false;
                            return false;
                        }
                    });
                    $('#selectAll').prop('checked', allChecked);
                }
            });
        });
        function abrirModalCrearPersona() {
            $('#modalPersonaContent').load('/Personas/CrearDesdeModal');
            $('#modalNuevaPersona').modal('show');
        }
        function personaCreada(id, nombreCompleto) {
            const select = $('.select2');
            select.find('option').each(function () {
                if ($(this).val() === id.toString() || $(this).text().trim() === nombreCompleto.trim()) {
                    $(this).remove();
                }
            });
            const nuevaOpcion = new Option(nombreCompleto, id, true, true);
            select.append(nuevaOpcion).val(id).trigger('change');
            $('#modalNuevaPersona').modal('hide');
        }
    </script>
}
@section Styles {
    <style>
        .card {
            margin-bottom: 1rem;
        }

        .table> :not(caption)>*>* {
            padding: 1rem;
        }

        .form-check-input {
            cursor: pointer;
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
            line-height: 38px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, .02);
        }
    </style>
}
