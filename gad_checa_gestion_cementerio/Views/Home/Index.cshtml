@model gad_checa_gestion_cementerio.Models.Views.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard - Gestión Cementerio";
}
<!-- Script de datos generado desde el backend -->
<script>
    const datosIngresos = @Html.Raw(Json.Serialize(Model.IngresosMensuales));
    const contratosData = {
        activos: @Model.ContratosActivos,
        porVencer: @Model.ContratosPorVencer,
        vencidos: @Model.ContratosVencidos
    };
    const espaciosData = {
        bovedasDisponibles: @Model.BovedasDisponibles,
        bovedasOcupadas: @Model.BovedasOcupadas,
        nichosDisponibles: @Model.NichosDisponibles,
        nichosOcupados: @Model.NichosOcupados
    };
</script>

<div class="container-fluid">
    <!-- HEADER -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">Dashboard - Gestión del Cementerio</h2>
                    <p class="text-muted mb-0 small">Vista general del estado operativo y financiero</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                        <i class="ti ti-refresh me-1"></i>Actualizar
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ti ti-calendar me-1"></i>@DateTime.Now.ToString("MMMM yyyy")
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Este mes</a></li>
                            <li><a class="dropdown-item" href="#">Últimos 3 meses</a></li>
                            <li><a class="dropdown-item" href="#">Este año</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- METRICS SECTION -->
    <div class="row mb-3">
        <div class="col-12 mb-2">
            <h5 class="section-title mb-3">
                <i class="ti ti-chart-bar text-primary me-2"></i>
                Indicadores Principales
            </h5>
        </div>
    </div>

    <!-- KPI CARDS -->
    <div class="row mb-4">
        <!-- Número de Difuntos -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Total Difuntos</h6>
                            <h3 class="mb-1 text-primary">@Model.NumeroDifuntos.ToString("N0")</h3>
                            <small class="text-muted">Registrados en el sistema</small>
                        </div>
                        <div class="avatar bg-light-primary text-primary">
                            <i class="ti ti-user-check f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ingresos Totales -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Ingresos Totales</h6>
                            <h3 class="mb-1 text-warning">$@Model.IngresosMensuales.Sum(x => x.TotalIngresado).ToString("N0")</h3>
                            <small class="text-muted">Este año</small>
                        </div>
                        <div class="avatar bg-light-warning text-warning">
                            <i class="ti ti-currency-dollar f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-warning" style="width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bóvedas Disponibles -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Bóvedas Disponibles</h6>
                            <h3 class="mb-1 text-success">@Model.BovedasDisponibles.ToString("N0")</h3>
                            <small class="text-muted">Sin contrato activo</small>
                        </div>
                        <div class="avatar bg-light-success text-success">
                            <i class="ti ti-box f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bóvedas Ocupadas -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Bóvedas Ocupadas</h6>
                            <h3 class="mb-1 text-info">@Model.BovedasOcupadas.ToString("N0")</h3>
                            <small class="text-muted">Con contrato activo</small>
                        </div>
                        <div class="avatar bg-light-info text-info">
                            <i class="ti ti-user-check f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-info" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nichos Disponibles -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Nichos Disponibles</h6>
                            <h3 class="mb-1 text-success">@Model.NichosDisponibles.ToString("N0")</h3>
                            <small class="text-muted">Actualmente libres</small>
                        </div>
                        <div class="avatar bg-light-success text-success">
                            <i class="ti ti-check f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Nichos Ocupados -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Nichos Ocupados</h6>
                            <h3 class="mb-1 text-secondary">@Model.NichosOcupados.ToString("N0")</h3>
                            <small class="text-muted">Ya asignados</small>
                        </div>
                        <div class="avatar bg-light-secondary text-secondary">
                            <i class="ti ti-user f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-secondary" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bóvedas por Caducar -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Bóvedas por Caducar</h6>
                            <h3 class="mb-1 text-warning">@Model.BovedasPorCaducar.ToString("N0")</h3>
                            <small class="text-muted">Contratos por vencer</small>
                        </div>
                        <div class="avatar bg-light-warning text-warning">
                            <i class="ti ti-alert-triangle f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-warning" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Ingresos del Año -->
        <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-2 f-w-400 text-muted">Total Ingresos del Año</h6>
                            <h3 class="mb-1 text-primary">$@Model.IngresosMensuales.Sum(s => s.TotalIngresado).ToString("N0")</h3>
                            <small class="text-muted">Acumulado anual</small>
                        </div>
                        <div class="avatar bg-light-primary text-primary">
                            <i class="ti ti-trending-up f-24"></i>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 4px;">
                        <div class="progress-bar bg-primary" style="width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ANALYTICS SECTION -->
    <div class="row mb-3">
        <div class="col-12 mb-2">
            <h5 class="section-title mb-3">
                <i class="ti ti-chart-pie text-success me-2"></i>
                Análisis y Estadísticas
            </h5>
        </div>
    </div>

    <!-- CHARTS ROW 1 -->
    <div class="row mb-4">
        <!-- Espacios por Tipo - PIE CHART -->
        <div class="col-12 col-md-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="ti ti-pie-chart text-primary me-2"></i>
                        Distribución de Espacios
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div id="espacios-pie-chart" style="height: 250px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Estado de Contratos - DONUT CHART -->
        <div class="col-12 col-md-6 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="ti ti-donut text-success me-2"></i>
                        Estado de Contratos
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div id="contratos-donut-chart" style="height: 250px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- Alertas y Notificaciones -->
        <div class="col-12 col-xl-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="ti ti-bell text-warning me-2"></i>
                        Alertas Importantes
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.BovedasPorCaducar > 0)
                    {
                        <div class="alert alert-warning border-0 mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-alert-triangle me-2"></i>
                                <div>
                                    <strong>@Model.BovedasPorCaducar contratos</strong> próximos a vencer
                                    <br><small class="text-muted">Requieren atención inmediata</small>
                                </div>
                            </div>
                        </div>
                    }

                    @if (Model.ContratosVencidos > 0)
                    {
                        <div class="alert alert-danger border-0 mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-alert-circle me-2"></i>
                                <div>
                                    <strong>@Model.ContratosVencidos contratos</strong> ya vencidos
                                    <br><small class="text-muted">Acción requerida</small>
                                </div>
                            </div>
                        </div>
                    }

                    @{
                        var totalEspacios = Model.BovedasDisponibles + Model.BovedasOcupadas + Model.NichosDisponibles + Model.NichosOcupados;
                        var porcentajeOcupacion = totalEspacios > 0 ? ((Model.BovedasOcupadas + Model.NichosOcupados) * 100.0 / totalEspacios) : 0;
                    }

                    @if (porcentajeOcupacion > 90)
                    {
                        <div class="alert alert-danger border-0 mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-building-x me-2"></i>
                                <div>
                                    <strong>Capacidad crítica:</strong> @porcentajeOcupacion.ToString("F1")% ocupación
                                    <br><small class="text-muted">Considerar expansión</small>
                                </div>
                            </div>
                        </div>
                    }
                    else if (porcentajeOcupacion > 75)
                    {
                        <div class="alert alert-warning border-0 mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-building-alert me-2"></i>
                                <div>
                                    <strong>Alta ocupación:</strong> @porcentajeOcupacion.ToString("F1")% ocupación
                                    <br><small class="text-muted">Monitorear disponibilidad</small>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success border-0 mb-3" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="ti ti-building-check me-2"></i>
                                <div>
                                    <strong>Capacidad adecuada:</strong> @porcentajeOcupacion.ToString("F1")% ocupación
                                    <br><small class="text-muted">Todo en orden</small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- CHARTS ROW 2 -->
    <div class="row mb-4">
        <!-- Ingresos vs Deudas - BAR CHART -->
        <div class="col-12 col-lg-8 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-chart-bar text-info me-2"></i>
                        Ingresos vs Deudas Mensuales
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ti ti-calendar me-1"></i>Este año
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Este mes</a></li>
                            <li><a class="dropdown-item" href="#">Últimos 6 meses</a></li>
                            <li><a class="dropdown-item" href="#">Este año</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="ingresos-bar-chart" style="height: 280px;"></div>
                </div>
            </div>
        </div>

        <!-- Transacciones Recientes -->
        <div class="col-12 col-lg-4 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-receipt text-success me-2"></i>
                        Transacciones Recientes
                    </h5>
                    <a href="@Url.Action("Index", "Cobros")" class="btn btn-sm btn-outline-primary">
                        Ver todas
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.TransaccionesRecientes != null && Model.TransaccionesRecientes.Any())
                    {
                        <div class="d-grid gap-3">
                            @foreach (var tx in Model.TransaccionesRecientes.Take(8))
                            {
                                <div class="d-flex align-items-center p-2 rounded bg-light">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar @(tx.Monto >= 0 ? "bg-light-success text-success" : "bg-light-danger text-danger")">
                                            <i class="ti ti-@(tx.Monto >= 0 ? "arrow-down" : "arrow-up")"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 small">@tx.NombrePersona</h6>
                                        <p class="mb-0 text-muted small">
                                            <i class="ti ti-calendar me-1"></i>
                                            @tx.FechaPago.ToString("dd MMM")
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0 text-end">
                                        <h6 class="mb-0 small @(tx.Monto >= 0 ? "text-success" : "text-danger")">
                                            @(tx.Monto >= 0 ? "+" : "-")$@Math.Abs(tx.Monto).ToString("N0")
                                        </h6>
                                        <small class="text-muted">#@tx.NumeroComprobante</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="ti ti-receipt-off h1 mb-3"></i>
                            <p class="mb-0">No hay transacciones recientes</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- CHARTS ROW 3 -->
    <div class="row mb-5">
        <!-- Tendencia de Ingresos - AREA CHART -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="mb-0">
                        <i class="ti ti-chart-line text-primary me-2"></i>
                        Tendencia de Ingresos
                    </h5>
                </div>
                <div class="card-body">
                    <div id="ingresos-area-chart" style="height: 250px;"></div>
                </div>
            </div>
        </div>

        <!-- Últimos Contratos -->
        <div class="col-12 col-lg-6 mb-4">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="ti ti-file-text text-secondary me-2"></i>
                        Últimos Contratos
                    </h5>
                    <a href="@Url.Action("Index", "Contratos")" class="btn btn-sm btn-outline-primary">
                        Ver todos
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.UltimosContratos != null && Model.UltimosContratos.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">Número</th>
                                        <th class="border-0">Vencimiento</th>
                                        <th class="border-0">Estado</th>
                                        <th class="border-0 text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var contrato in Model.UltimosContratos.Take(5))
                                    {
                                        <tr>
                                            <td>
                                                <span class="fw-medium">@contrato.NumeroSecuencial</span>
                                            </td>
                                            <td>
                                                <span class="small">@contrato.FechaFin.ToString("dd/MM/yyyy")</span>
                                            </td>
                                            <td>
                                                <span class="badge @(contrato.EstadoContrato switch {
                                                    "Vencido" => "bg-danger",
                                                    "Próximo a vencer" => "bg-warning",
                                                    _ => "bg-success"
                                                })">
                                                    @contrato.EstadoContrato
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <span class="fw-medium">$@contrato.MontoTotal.ToString("N0")</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="ti ti-file-x h1 mb-3"></i>
                            <p class="mb-0">No hay contratos registrados</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK ACCESS SECTION -->
    <div class="row mb-3">
        <div class="col-12 mb-2">
            <h5 class="section-title mb-3">
                <i class="ti ti-layout-dashboard text-info me-2"></i>
                Accesos Rápidos
            </h5>
        </div>
    </div>

    <!-- ACCESOS RÁPIDOS -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("Create", "Contratos")" class="card text-center p-3 border-0 bg-light-primary text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-file-plus text-primary mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Nuevo Contrato</div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("Index", "Contratos")" class="card text-center p-3 border-0 bg-light-success text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-files text-success mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Ver Contratos</div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("Index", "Bovedas")" class="card text-center p-3 border-0 bg-light-info text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-building text-info mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Gestionar Espacios</div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("Index", "Difuntos")" class="card text-center p-3 border-0 bg-light-secondary text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-users text-secondary mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Registro Difuntos</div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("Index", "Cobros")" class="card text-center p-3 border-0 bg-light-warning text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-receipt text-warning mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Cobros</div>
                                </div>
                            </a>
                        </div>
                        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                            <a href="@Url.Action("CuentasPorCobrar", "Reportes")" class="card text-center p-3 border-0 bg-light-danger text-decoration-none h-100 hover-lift">
                                <div class="card-body">
                                    <i class="ti ti-chart-bar text-danger mb-2" style="font-size: 1.8rem;"></i>
                                    <div class="fw-medium small">Reportes</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- ApexCharts JS -->
    <script src="~/js/plugins/apexcharts.min.js"></script>

    <script>
        // Configuración de colores consistente
        const colors = {
            primary: '#1890ff',
            success: '#52c41a',
            warning: '#faad14',
            danger: '#ff4d4f',
            info: '#13c2c2',
            secondary: '#6c757d'
        };

        // Meses en español
        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        // 1. GRÁFICO DE PIE - Distribución de Espacios
        const espaciosTotales = espaciosData.bovedasDisponibles + espaciosData.bovedasOcupadas +
                               espaciosData.nichosDisponibles + espaciosData.nichosOcupados;

        if (espaciosTotales > 0) {
            new ApexCharts(document.querySelector("#espacios-pie-chart"), {
                chart: {
                    type: 'pie',
                    height: 300,
                    fontFamily: 'Public Sans, sans-serif',
                    toolbar: { show: false }
                },
                labels: ['Bóvedas Disponibles', 'Bóvedas Ocupadas', 'Nichos Disponibles', 'Nichos Ocupados'],
                series: [
                    espaciosData.bovedasDisponibles,
                    espaciosData.bovedasOcupadas,
                    espaciosData.nichosDisponibles,
                    espaciosData.nichosOcupados
                ],
                colors: [colors.success, colors.primary, colors.warning, colors.info],
                legend: {
                    position: 'bottom',
                    fontSize: '12px'
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return value + ' espacios';
                        }
                    }
                },
                dataLabels: {
                    style: { fontSize: '12px' }
                }
            }).render();
        } else {
            document.querySelector("#espacios-pie-chart").innerHTML =
                "<div class='text-center text-muted py-4'><i class='ti ti-building-x h1 mb-3'></i><p>No hay datos de espacios</p></div>";
        }

        // 2. GRÁFICO DE DONUT - Estado de Contratos
        const contratosTotales = contratosData.activos + contratosData.porVencer + contratosData.vencidos;

        if (contratosTotales > 0) {
            new ApexCharts(document.querySelector("#contratos-donut-chart"), {
                chart: {
                    type: 'donut',
                    height: 300,
                    fontFamily: 'Public Sans, sans-serif',
                    toolbar: { show: false }
                },
                labels: ['Activos', 'Por Vencer', 'Vencidos'],
                series: [
                    contratosData.activos,
                    contratosData.porVencer,
                    contratosData.vencidos
                ],
                colors: [colors.success, colors.warning, colors.danger],
                legend: {
                    position: 'bottom',
                    fontSize: '12px'
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return value + ' contratos';
                        }
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            labels: {
                                show: true,
                                total: {
                                    show: true,
                                    label: 'Total',
                                    formatter: function(w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                    }
                                }
                            }
                        }
                    }
                }
            }).render();
        } else {
            document.querySelector("#contratos-donut-chart").innerHTML =
                "<div class='text-center text-muted py-4'><i class='ti ti-file-x h1 mb-3'></i><p>No hay contratos registrados</p></div>";
        }

        // 3. GRÁFICO DE BARRAS - Ingresos vs Deudas
        if (datosIngresos && datosIngresos.length > 0) {
            const categorias = datosIngresos.map(d => meses[d.mes - 1]);
            const ingresos = datosIngresos.map(d => d.totalIngresado);
            const deudas = datosIngresos.map(d => d.totalDeuda);

            new ApexCharts(document.querySelector("#ingresos-bar-chart"), {
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: 'Public Sans, sans-serif',
                    toolbar: { show: false }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '60%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                colors: [colors.primary, colors.danger],
                series: [
                    {
                        name: 'Ingresos',
                        data: ingresos
                    },
                    {
                        name: 'Deudas',
                        data: deudas
                    }
                ],
                xaxis: {
                    categories: categorias,
                    labels: {
                        rotate: -45,
                        style: { fontSize: '11px' }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'k';
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                }
            }).render();
        } else {
            document.querySelector("#ingresos-bar-chart").innerHTML =
                "<div class='text-center text-muted py-4'><i class='ti ti-chart-bar h1 mb-3'></i><p>No hay datos de ingresos</p></div>";
        }

        // 4. GRÁFICO DE ÁREA - Tendencia de Ingresos
        if (datosIngresos && datosIngresos.length > 0) {
            // Preparar datos para el gráfico de área (últimos 12 meses)
            const ingresosPorMes = Array(12).fill(0);
            const deudasPorMes = Array(12).fill(0);

            datosIngresos.forEach(d => {
                const mesIndex = d.mes - 1;
                if (mesIndex >= 0 && mesIndex < 12) {
                    ingresosPorMes[mesIndex] = d.totalIngresado;
                    deudasPorMes[mesIndex] = d.totalDeuda;
                }
            });

            new ApexCharts(document.querySelector("#ingresos-area-chart"), {
                chart: {
                    type: 'area',
                    height: 300,
                    fontFamily: 'Public Sans, sans-serif',
                    toolbar: { show: false }
                },
                dataLabels: {
                    enabled: false
                },
                colors: [colors.primary, colors.warning],
                series: [
                    {
                        name: 'Ingresos',
                        data: ingresosPorMes
                    },
                    {
                        name: 'Deudas',
                        data: deudasPorMes
                    }
                ],
                stroke: {
                    curve: 'smooth',
                    width: 2
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        opacityFrom: 0.4,
                        opacityTo: 0.1
                    }
                },
                xaxis: {
                    categories: meses,
                    labels: {
                        style: { fontSize: '11px' }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(value) {
                            return '$' + (value / 1000).toFixed(0) + 'k';
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right'
                }
            }).render();
        } else {
            document.querySelector("#ingresos-area-chart").innerHTML =
                "<div class='text-center text-muted py-4'><i class='ti ti-chart-line h1 mb-3'></i><p>No hay datos de tendencias</p></div>";
        }
    </script>
}

<!-- CONTENIDO ADICIONAL DEL DASHBOARD -->
<div class="container-fluid mt-4">
    <!-- GRÁFICOS Y CONTENIDO PRINCIPAL -->
    <div class="row mb-4">
        <!-- Gráfico de Ingresos Mensuales -->
        <div class="col-md-12 col-xl-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="ti ti-chart-line me-2 text-primary"></i>
                        Ingresos Mensuales
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="ti ti-calendar me-1"></i> Este Año
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Este mes</a></li>
                            <li><a class="dropdown-item" href="#">Últimos 3 meses</a></li>
                            <li><a class="dropdown-item" href="#">Este año</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div id="ingresos-chart" style="height: 280px;"></div>
                </div>
            </div>
        </div>

        <!-- Historial de Transacciones -->
        <div class="col-md-12 col-xl-4 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="ti ti-wallet me-2 text-success"></i>
                        Transacciones Recientes
                    </h5>
                    <a href="@Url.Action("Index", "Cobros")" class="btn btn-sm btn-outline-primary">
                        Ver todas
                    </a>
                </div>
                <div class="card-body">
                    @if (Model.TransaccionesRecientes != null && Model.TransaccionesRecientes.Any())
                    {
                        <div class="d-grid gap-3">
                            @foreach (var tx in Model.TransaccionesRecientes.Take(6))
                            {
                                <div class="d-flex align-items-center p-2 rounded bg-light">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar @(tx.Monto >= 0 ? "bg-light-success text-success" : "bg-light-danger text-danger")">
                                            <i class="ti ti-@(tx.Monto >= 0 ? "arrow-down" : "arrow-up")"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 small">@tx.NombrePersona</h6>
                                        <p class="mb-0 text-muted small">
                                            <i class="ti ti-calendar me-1"></i>
                                            @tx.FechaPago.ToString("dd MMM yyyy")
                                        </p>
                                    </div>
                                    <div class="flex-shrink-0 text-end">
                                        <h6 class="mb-0 small @(tx.Monto >= 0 ? "text-success" : "text-danger")">
                                            @(tx.Monto >= 0 ? "+" : "-")$@Math.Abs(tx.Monto).ToString("N0")
                                        </h6>
                                        <small class="text-muted">#@tx.NumeroComprobante</small>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="ti ti-receipt-off h1 mb-3"></i>
                            <p class="mb-0">No hay transacciones recientes</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

