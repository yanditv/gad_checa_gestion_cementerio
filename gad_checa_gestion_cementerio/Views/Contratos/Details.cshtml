@model gad_checa_gestion_cementerio.Models.ContratoModel

@{
    ViewData["Title"] = "Detalles del Contrato";
}

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="card-title mb-0">
                    <i class="fas fa-file-contract me-2"></i>@ViewData["Title"]
                </h4>
                <p class="text-muted mb-0 mt-1">Contrato #@Model.NumeroSecuencial</p>
            </div>
            <div class="d-flex gap-2">
                <a href="@Url.Action("Print", new { id = Model.Id })" class="btn btn-primary" target="_blank">
                    <i class="fas fa-print me-2"></i>Imprimir Contrato
                </a>
                <a href="@Url.Action("PrintRecibo", new { id = Model.Id })" class="btn btn-success" target="_blank">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Imprimir Recibo
                </a>
            </div>
        </div>
    </div>

    <div class="card-body">
        <div class="row">
            <!-- Información del Contrato -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Contrato</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-hashtag text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Número de Contrato</small>
                                        <span class="fw-bold">@Model.NumeroSecuencial</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-alt text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Fecha de Inicio</small>
                                        <span class="fw-bold">@Model.FechaInicio.ToString("dd/MM/yyyy")</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar-check text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Fecha de Fin</small>
                                        <span class="fw-bold">@(Model.FechaFin?.ToString("dd/MM/yyyy") ??
                                            "Indefinido")</ span >
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-clock text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Duración</small>
                                        <span class="fw-bold">@Model.NumeroDeMeses Años</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-dollar-sign text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Monto Total</small>
                                        <span class="fw-bold">$@Model.MontoTotal.ToString("N2")</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Estado</small>
                                        <span class="badge @(Model.Estado ? "bg-success" : "bg-danger")">
                                            @(Model.Estado ? "Activo" : "Inactivo")
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-sync text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Tipo de Contrato</small>
                                        <span class="fw-bold">@(Model.EsRenovacion ? "Renovación" : "Original")</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.EsRenovacion && Model.ContratoOrigenId.HasValue && ViewBag.ContratoOrigen != null)
                        {
                            <div class="col-12">
                                <div class="alert alert-info mb-0">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span class="fw-bold">Este contrato es una renovación</span>
                                    </div>
                                    <p class="mb-1">Contrato original: <span class="fw-bold">@ViewBag.ContratoOrigen.NumeroSecuencial</span></p>
                                    <p class="mb-1">Fecha de inicio original: <span class="fw-bold">@ViewBag.ContratoOrigen.FechaInicio.ToString("dd/MM/yyyy")</span></p>
                                    <p class="mb-0">Fecha de finalización original: <span class="fw-bold">@(ViewBag.ContratoOrigen.FechaFin?.ToString("dd/MM/yyyy") ?? "No definida")</span></p>
                                    <a asp-action="Details" asp-route-id="@Model.ContratoOrigenId" class="btn btn-outline-info btn-sm mt-2">
                                        <i class="fas fa-arrow-left me-1"></i> Ver contrato original
                                    </a>
                                </div>
                            </div>
                        }
                        
                        @if (ViewBag.ContratosHijos != null && ViewBag.ContratosHijos.Count > 0)
                        {
                            <div class="col-12 mt-3">
                                <div class="alert alert-warning mb-0">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <i class="fas fa-code-branch me-2"></i>
                                            <span class="fw-bold">Este contrato ha sido renovado</span>
                                        </div>
                                        <div>
                                            <span class="badge bg-primary">
                                                @(ViewBag.TotalRenovacionesEnCadena ?? ViewBag.ContratosHijos.Count) de @ViewBag.MaxRenovacionesPermitidas
                                                renovaciones
                                            </span>
                                        </div>
                                    </div>
                                    <p class="mb-2">Este contrato tiene @ViewBag.ContratosHijos.Count renovación(es) directa(s):</p>
                                    <ul class="mb-0">
                                    @foreach (var hijo in ViewBag.ContratosHijos)
                                    {
                                        <li class="mb-1">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="fw-bold">@hijo.NumeroSecuencial</span> - 
                                                    @hijo.FechaInicio.ToString("dd/MM/yyyy") al @(hijo.FechaFin?.ToString("dd/MM/yyyy") ?? "Sin fecha fin")
                                                </div>
                                                <a asp-action="Details" asp-route-id="@hijo.Id" class="btn btn-outline-info btn-sm ms-1">
                                                    <i class="fas fa-arrow-right me-1"></i> Ver
                                                </a>
                                            </div>
                                        </li>
                                    }
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Información de la Bóveda -->
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-building me-2"></i>Información de la Bóveda</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-building text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Bloque</small>
                                        <span class="fw-bold">@Model.Boveda?.Piso?.Bloque?.Descripcion</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-layer-group text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Piso</small>
                                        <span class="fw-bold">@Model.Boveda?.Piso?.NumeroPiso</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-box text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Bóveda</small>
                                        <span class="fw-bold">@Model.Boveda?.Numero</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-user-tie text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Propietario</small>
                                        <span class="fw-bold">@(Model.Boveda?.Propietario != null ?
                                            $"{Model.Boveda.Propietario.Nombres} {Model.Boveda.Propietario.Apellidos}" :
                                                                                        "Sin propietario")</ span >
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Difunto -->
        @if (Model.Difunto != null)
        {
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Información del Difunto</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle bg-primary text-white me-3">
                                    @Model.Difunto.Nombres[0]@Model.Difunto.Apellidos[0]
                                </div>
                                <div>
                                    <h6 class="mb-0">@Model.Difunto.Nombres @Model.Difunto.Apellidos</h6>
                                    <small class="text-muted">ID: @Model.Difunto.Id</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-id-card text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Identificación</small>
                                    <span class="fw-bold">@Model.Difunto.NumeroIdentificacion</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-calendar-times text-primary me-2"></i>
                                <div>
                                    <small class="text-muted d-block">Fecha de Fallecimiento</small>
                                    <span class="fw-bold">@Model.Difunto.FechaFallecimiento.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Responsables -->
        @if (Model.Responsables?.Any() == true)
        {
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Responsables</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user me-2 text-primary"></i>
                                            <span>Nombre Completo</span>
                                        </div>
                                    </th>
                                    <th class="border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-id-card me-2 text-primary"></i>
                                            <span>Identificación</span>
                                        </div>
                                    </th>
                                    <th class="border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-phone me-2 text-primary"></i>
                                            <span>Teléfono</span>
                                        </div>
                                    </th>
                                    <th class="border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-envelope me-2 text-primary"></i>
                                            <span>Correo</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var responsable in Model.Responsables)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-info text-white me-3">
                                                    @responsable.Nombres[0]@responsable.Apellidos[0]
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">@responsable.Nombres @responsable.Apellidos</h6>
                                                    <small class="text-muted">@responsable.FechaFin</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@responsable.NumeroIdentificacion</td>
                                        <td>@responsable.Telefono</td>
                                        <td>@responsable.Email</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Cuotas -->
        @if (Model.Cuotas?.Any() == true)
        {
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Cuotas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="border-0">#</th>
                                    <th class="border-0">Fecha de Vencimiento</th>
                                    <th class="border-0">Monto</th>
                                    <th class="border-0">Estado</th>
                                    <th class="border-0">Fecha de Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cuota in Model.Cuotas)
                                {
                                    <tr>
                                        <td>@cuota.Id</td>
                                        <td>@cuota.FechaVencimiento.ToString("dd/MM/yyyy")</td>
                                        <td>$@cuota.Monto.ToString("N2")</td>
                                        <td>
                                            <span
                                                class="badge @(cuota.Estado == "Pagado" ? "bg-success" : 
                                                                                                     cuota.Estado == "Pendiente" ? "bg-warning" : "bg-danger")">
                                            @cuota.Estado
                                        </span>
                                    </td>
                                    <td>@(cuota.FechaPago?.ToString("dd/MM/yyyy") ?? "-")</td>
                                </tr>
                                                        }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Botones de Acción -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .table> :not(caption)>*>* {
            padding: 1rem;
        }

        .badge {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, .02);
        }
    </style>
}
