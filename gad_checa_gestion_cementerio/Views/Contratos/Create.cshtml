@model gad_checa_gestion_cementerio.Models.CreateContratoModel
@{
    ViewData["Title"] = "Crear Contrato";
}

<div class="">
    <!-- Card -->
    <div class="d-flex flex-column">
        <div class="overflow-auto">
            <div class="d-inline-block w-100 align-middle">
                <div class="bg-secondary border overflow-hidden rounded-xl shadow-sm">
                    <!-- Header -->
                    <div class="px-4 py-3 border-bottom d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="text-white h4">
                                Contrato de Servicio de Arrendamiento de Cementerio
                            </h2>
                            <p class="text-white small" id="numero-secuencial-contrato">
                                @Model.contrato.NumeroSecuencial
                            </p>
                        </div>
                        <div>
                            <div class="d-flex align-items-center">
                                <!-- Botón "Ver todos" -->
                                <a class="btn btn-outline-light" asp-action="Index">
                                    Ver todos
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md pb-2 p-4">
        <!-- Stepper -->
        <div id="stepper">
            <!-- Stepper Nav -->
            <div class="stepper">
                <div class="step completed" data-step="1">
                    <div class="circle">1</div>
                    <div>Datos del contrato</div>
                </div>
                <div class="step" data-step="2">
                    <div class="circle">2</div>
                    <div>Datos del Difunto</div>
                </div>
                <div class="step" data-step="3">
                    <div class="circle">3</div>
                    <div>Datos de los Responsables</div>
                </div>
                <div class="step" data-step="4">
                    <div class="circle">4</div>
                    <div>Pago</div>
                </div>
                <div class="step" data-step="5">
                    <div class="circle">5</div>
                    <div>Verificación de Datos</div>
                </div>
            </div>
            <div class="bg-light" id="mensajes"></div>
            <!-- End Stepper Nav -->

            <!-- Stepper Content -->
            <div class="mt-4">
                <!-- Contenido dinámico -->
                <div data-content="1">
                    @await Html.PartialAsync("_CreateContrato", Model.contrato)
                </div>
                <div data-content="2" style="display: none;"></div>
                <div data-content="3" style="display: none;"></div>
                <div data-content="4" style="display: none;"></div>
                <div data-content="5" style="display: none;"></div>

                <!-- Button Group -->
                <div class="mt-4 mb-4 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" id="backBtn" disabled>
                        <i class="ti ti-arrow-left me-1"></i> Atrás
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Siguiente <i class="ti ti-arrow-right me-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="finishBtn" style="display: none;">
                        Finalizar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container--default .select2-selection--single {
            height: calc(1.5em + 1rem + 2px);
            padding: 0.5rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + 1rem + 2px);
        }
    </style>
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // Configuración global
        const stepUrls = {
            1: '@Url.Action("CreateContrato", "Contratos")',
            2: '@Url.Action("CreateDifunto", "Contratos")',
            3: '@Url.Action("CreateResponsables", "Contratos")',
            4: '@Url.Action("CreatePago", "Contratos")',
            5: '@Url.Action("DocumentoContrato", "Contratos")'
        };

        // Variables de estado
        let currentStep = 1;
        const steps = document.querySelectorAll('.step');
        const contents = document.querySelectorAll('[data-content]');
        const mensajesDiv = document.getElementById('mensajes');

        // Función para cargar contenido del paso
        async function loadStepContent(step) {
            const contentDiv = document.querySelector(`[data-content="${step}"]`);

            if (contentDiv.innerHTML.trim() === '') {
                try {
                    const response = await fetch(stepUrls[step]);
                    if (!response.ok) throw new Error('Error al cargar el paso');

                    contentDiv.innerHTML = await response.text();

                    // Inicializar componentes específicos
                    if (step === 3) {
                        initSelect2();
                    }

                    return true;
                } catch (error) {
                    console.error('Error loading step:', error);
                    contentDiv.innerHTML = `                                                                                                                                        Error al cargar el contenido. Intente nuevamente.
                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                        `;
                    return false;
                }
            }
            return true;
        }

        // Inicializar Select2
        function initSelect2() {
            $('#searchResponsable').select2({
                placeholder: 'Buscar responsable...',
                allowClear: true
            }).on('select2:select', function (e) {
                const selectedOption = $(this).find('option:selected');
                const formData = new FormData();
                formData.append('Id', selectedOption.val());
                formData.append('Nombres', selectedOption.data('nombres'));
                formData.append('Apellidos', selectedOption.data('apellidos'));
                formData.append('TipoIdentificacion', selectedOption.data('tipo'));
                formData.append('NumeroIdentificacion', selectedOption.data('numero'));

                console.log('Enviando responsable:', {
                    Id: selectedOption.val(),
                    Nombres: selectedOption.data('nombres'),
                    Apellidos: selectedOption.data('apellidos'),
                    TipoIdentificacion: selectedOption.data('tipo'),
                    NumeroIdentificacion: selectedOption.data('numero')
                });

                fetch('@Url.Action("AddResponsable", "Contratos")', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Agregar el nuevo responsable al contenedor
                            var responsableHtml = `
                                    <div class="responsable mb-4" data-id="${selectedOption.val()}">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <div class="d-flex align-items-center">
                                                            <i class="ti ti-user me-2 fs-4"></i>
                                                            <div class="flex-grow-1">
                                                                <h5 class="mb-1">${selectedOption.data('nombres')} ${selectedOption.data('apellidos')}</h5>
                                                                <p class="mb-0 text-muted">
                                                                    ${selectedOption.data('tipo')}: ${selectedOption.data('numero')}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Fecha Inicio</label>
                                                                    <input type="date" class="form-control fecha-inicio" 
                                                                        value="${new Date().toISOString().split('T')[0]}" />
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Fecha Fin</label>
                                                                    <input type="date" class="form-control fecha-fin" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="text-end mt-2">
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeResponsable(${selectedOption.val()})">
                                                        <i class="ti ti-trash me-1"></i>Quitar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            document.getElementById('responsablesContainer').innerHTML += responsableHtml;
                            // Limpiar la selección
                            $('#searchResponsable').val(null).trigger('change');
                        } else {
                            console.error('Error:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        }

        function removeResponsable(id) {
            if (!confirm('¿Está seguro de quitar este responsable?')) {
                return;
            }

            var formData = new FormData();
            formData.append('id', id);

            fetch('@Url.Action("RemoveResponsable", "Contratos")', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Eliminar solo el elemento específico del DOM
                        var elementToRemove = document.querySelector(`.responsable[data-id="${id}"]`);
                        if (elementToRemove) {
                            elementToRemove.remove();
                        }
                    } else {
                        alert(data.message || 'Error al quitar el responsable');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al quitar el responsable');
                });
        }

        // Función para actualizar el stepper
        function updateStepper() {
            steps.forEach((step, index) => {
                const stepNumber = parseInt(step.dataset.step);
                if (stepNumber === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else if (stepNumber < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });

            contents.forEach((content, index) => {
                const contentStep = parseInt(content.dataset.content);
                content.style.display = contentStep === currentStep ? 'block' : 'none';
            });

            document.getElementById('backBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').style.display = currentStep === 5 ? 'none' : 'block';
            document.getElementById('finishBtn').style.display = currentStep === 5 ? 'block' : 'none';
        }

        // Función global para abrir modal
        window.abrirModal = function () {
            new bootstrap.Modal(document.getElementById('crearResponsableModal')).show();
        };

        // Manejar navegación
        document.getElementById('nextBtn').addEventListener('click', async function () {
            if (currentStep < 5) {
                const success = await loadStepContent(currentStep + 1);
                if (success) {
                    currentStep++;
                    updateStepper();
                }
            }
        });

        document.getElementById('backBtn').addEventListener('click', async function () {
            if (currentStep > 1) {
                const success = await loadStepContent(currentStep - 1);
                if (success) {
                    currentStep--;
                    updateStepper();
                }
            }
        });

        // Manejar finalización
        document.getElementById('finishBtn').addEventListener('click', function () {
            // Tu lógica para finalizar el contrato
            console.log('Contrato finalizado');
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            // Cargar el primer paso
            loadStepContent(1);

            // Configurar tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        function guardarResponsable() {
            const form = document.getElementById('formResponsable');
            const formData = new FormData(form);
            const errorContainer = document.getElementById('errorContainer');
            const errorList = document.getElementById('errorList');

            // Limpiar errores anteriores
            errorContainer.classList.add('d-none');
            errorList.innerHTML = '';

            fetch('@Url.Action("GuardarResponsable", "Contratos")', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Cerrar el modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('crearResponsableModal'));
                        modal.hide();

                        // Limpiar el formulario
                        form.reset();

                        // Agregar el nuevo responsable a la lista
                        const responsable = data.responsable;
                        const responsableHtml = `
                                                                            <div class="responsable mb-4">
                                                                                <div class="card border-0 shadow-sm">
                                                                                    <div class="card-body">
                                                                                        <div class="row">
                                                                                            <div class="col-md-8">
                                                                                                <div class="d-flex align-items-center">
                                                                                                    <i class="ti ti-user me-2 fs-4"></i>
                                                                                                    <div class="flex-grow-1">
                                                                                                        <h5 class="mb-1">${responsable.nombres} ${responsable.apellidos}</h5>
                                                                                                        <p class="mb-0 text-muted">
                                                                                                            ${responsable.tipoIdentificacion}: ${responsable.numeroIdentificacion}
                                                                                                        </p>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                            <div class="col-md-4">
                                                                                                <div class="row">
                                                                                                    <div class="col-md-6">
                                                                                                        <div class="mb-3">
                                                                                                            <label class="form-label">Fecha Inicio</label>
                                                                                                            <input type="date" class="form-control fecha-inicio" value="${responsable.fechaInicio}" />
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    <div class="col-md-6">
                                                                                                        <div class="mb-3">
                                                                                                            <label class="form-label">Fecha Fin</label>
                                                                                                            <input type="date" class="form-control fecha-fin" value="${responsable.fechaFin || ''}" />
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="text-end mt-2">
                                                                                            <button type="button" class="btn btn-danger btn-sm remove-responsable-btn">
                                                                                                <i class="ti ti-trash me-1"></i>Quitar
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        `;
                        document.getElementById('responsablesContainer').insertAdjacentHTML('beforeend', responsableHtml);
                    } else {
                        // Mostrar errores en el modal
                        errorContainer.classList.remove('d-none');
                        errorList.innerHTML = '';
                        data.errors.forEach(error => {
                            const li = document.createElement('li');
                            li.textContent = error;
                            errorList.appendChild(li);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorContainer.classList.remove('d-none');
                    errorList.innerHTML = '<li>Error al guardar el responsable</li>';
                });
        }

        function loadResponsables() {
            var container = document.getElementById('responsablesContainer');
            container.innerHTML = ''; // Limpiar contenedor

            fetch('@Url.Action("CreateResponsables", "Contratos")', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                    // Reinicializar Select2 después de cargar los responsables
                    initSelect2();
                })
                .catch(error => {
                    console.error('Error al cargar responsables:', error);
                });
        }
    </script>

}
