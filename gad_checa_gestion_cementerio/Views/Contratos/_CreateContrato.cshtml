@model gad_checa_gestion_cementerio.Models.ContratoModel
@{
    ViewData["Title"] = "Crear Contrato";
}

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0 text-white">Datos del Contrato</h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4">Asegúrate de completar los campos necesarios</p>
            <form asp-action="CreateContrato" method="post">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Contrato</label>
                        <div>
                            @foreach (var tipo in Enum.GetValues(typeof(gad_checa_gestion_cementerio.Models.TipoContrato)))
                            {
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                        type="radio"
                                        name="TipoContrato"
                                        value="@((int)tipo)"
                                        id="TipoContrato_@tipo"
                                        @(Model.TipoContrato == (gad_checa_gestion_cementerio.Models.TipoContrato)tipo ? "checked" : "") />
                                    <label class="form-check-label" for="TipoContrato_@tipo">@tipo</label>
                                </div>
                            }
                        </div>
                        <span asp-validation-for="TipoContrato" class="text-danger"></span>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="NumeroSecuencial" class="form-label">Nro. Secuencial</label>
                        <input asp-for="NumeroSecuencial" readonly class="form-control" />
                        <span asp-validation-for="NumeroSecuencial" class="text-danger"></span>
                    </div>
                                        <div class="col-md-6 mb-3">
                        <label asp-for="BovedaId" class="form-label">Nro. Secuencial</label>
                        <input asp-for="BovedaId" readonly class="form-control" />
                        <span asp-validation-for="BovedaId" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        @* <label asp-for="BovedaId" class="form-label">Bóveda</label>
                        <div class="input-group"></div>
                        <select asp-for="BovedaId" class="form-control" asp-items="ViewBag.BovedaId"></select>
                         *@

                        
                        <button type="button" class="btn btn-secondary" onclick="abrirModalBovedas('')">
                            Buscar Disponibles
                        </button>
                        @* <button type="button" class="btn btn-secondary mt-2" data-bs-toggle="modal" data-bs-target="#modalBovedas">Buscar
                            Disponibles</button> *@
                        <span asp-validation-for="BovedaId" class="text-danger"></span>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="FechaInicio" class="form-label">Fecha de Inicio</label>
                        <input asp-for="FechaInicio" type="date" class="form-control" />
                        <span asp-validation-for="FechaInicio" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="FechaFin" class="form-label">Fecha de Fin</label>
                        <input asp-for="FechaFin" type="date" class="form-control" />
                        <span asp-validation-for="FechaFin" class="text-danger"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="NumeroDeMeses" class="form-label">Número de años</label>
                        <input asp-for="NumeroDeMeses" type="number" class="form-control" />
                        <span asp-validation-for="NumeroDeMeses" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="MontoTotal" class="form-label">Monto Total</label>
                        <input asp-for="MontoTotal" type="number" step="0.01" class="form-control" />
                        <span asp-validation-for="MontoTotal" class="text-danger"></span>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Observaciones" class="form-label">Observaciones</label>
                    <textarea asp-for="Observaciones" rows="3" class="form-control"></textarea>
                    <span asp-validation-for="Observaciones" class="text-danger"></span>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="contenedorModalBovedas"></div>
 @* @await Html.PartialAsync("_SelectBoveda", new List<gad_checa_gestion_cementerio.Models.BovedaModel>()) *@
    
    <script>
function abrirModalBovedas(filtro) {
    fetch('/Contratos/BuscarBovedas?filtro=' + encodeURIComponent(filtro))
        .then(response => response.text())
        .then(html => {
            document.getElementById('contenedorModalBovedas').innerHTML = html;

            // Asegurar que el DOM se actualice antes de inicializar el modal
            requestAnimationFrame(() => {
                const modalElement = document.getElementById('modalBovedas');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    console.error('modalBovedas no se encontró en el DOM.');
                }
            });
        });
}

        document.querySelectorAll('input[name="TipoContrato"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                let tipoSeleccionado = this.value;
                console.log('Tipo de contrato seleccionado:', tipoSeleccionado);
                fetch('@Url.Action("RecargarContratoByTipo", "Contratos")?tipoContrato=' + tipoSeleccionado)
                    .then(response => response.text())
                    .then(html => {
                        // Reemplaza el contenido del formulario por el nuevo HTML
                        document.querySelector('.card-body').innerHTML = html;
                    });
            });
        });


        document.getElementById('FechaInicio').addEventListener('change', calcularCuotas);
        document.getElementById('FechaFin').addEventListener('change', calcularCuotas);
        document.getElementById('MontoTotal').addEventListener('input', calcularCuotas);

        function calcularCuotas() {
            var fechaInicio = new Date(document.getElementById('FechaInicio').value);
            var fechaFin = new Date(document.getElementById('FechaFin').value);
            var montoTotal = parseFloat(document.getElementById('MontoTotal').value);
            var cuotasContainer = document.getElementById('cuotasContainer');
            cuotasContainer.innerHTML = '';

            if (isNaN(fechaInicio) || isNaN(fechaFin) || isNaN(montoTotal)) {
                return;
            }

            var numeroDeMeses = (fechaFin.getFullYear() - fechaInicio.getFullYear()) * 12 + (fechaFin.getMonth() - fechaInicio.getMonth());
            document.getElementById('NumeroDeMeses').value = numeroDeMeses;

            var montoCuota = montoTotal / numeroDeMeses;

            for (var i = 0; i < numeroDeMeses; i++) {
                var cuotaFecha = new Date(fechaInicio);
                cuotaFecha.setMonth(cuotaFecha.getMonth() + i);

                var cuotaDiv = document.createElement('div');
                cuotaDiv.className = 'form-group';

                var cuotaLabel = document.createElement('label');
                cuotaLabel.innerText = 'Cuota ' + (i + 1) + ' - Fecha: ' + cuotaFecha.toLocaleDateString() + ' - Monto: ' + montoCuota.toFixed(2);
                cuotaDiv.appendChild(cuotaLabel);

                cuotasContainer.appendChild(cuotaDiv);
            }
        }

    </script>

<script>

    function renderTablaBovedas(data) {
        const tbody = document.getElementById("tablaBovedasBody");
        tbody.innerHTML = ""; // Limpiar

        data.bovedas.forEach(boveda => {
            const row = document.createElement("tr");

            row.innerHTML = `
            <td>${boveda.numeroSecuecial}</td>
            <td>${boveda.numero}</td>
            <td>${boveda.estado}</td>
            <td>
                <button type="button" class="btn btn-success btn-sm"
                    onclick="seleccionarBoveda(${boveda.id}, '${boveda.numeroSecuecial}')">
                    Seleccionar
                </button>
            </td>
        `;

            tbody.appendChild(row);
        });

        // Aquí podrías regenerar también la paginación si quieres
        //renderPaginacion(data.paginaActual, data.totalPaginas);
    }

    function buscarBovedasJson(pagina = 1) {
        const filtro = document.getElementById("filtroBoveda").value;

        fetch(`/Contratos/BuscarBovedasJson?filtro=${encodeURIComponent(filtro)}&pagina=${pagina}`)
            .then(res => res.json())
            .then(data => {
                console.log("Bóvedas encontradas:", data);
                renderTablaBovedas(data);
            })
            .catch(err => {
                console.error("Error al buscar bóvedas:", err);
            });
    }

    function buscarBovedas(pagina) {
        const filtro = document.getElementById("filtroBoveda").value;

        fetch(`/Contrato/BuscarBovedas?filtro=${encodeURIComponent(filtro)}&pagina=${pagina}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("tablaBovedasBody").innerHTML = html;
            })
            .catch(err => {
                console.error("Error al buscar bóvedas:", err);
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formBusqueda = document.getElementById('formBusquedaBoveda');
        if (formBusqueda) {
            formBusqueda.addEventListener('submit', function (e) {
                e.preventDefault();
                buscarBovedasJson(1); // Siempre empieza desde la página 1
            });
        }
    });

// Seleccionar una bóveda y cerrar el modal
    function seleccionarBoveda(id, numeroSecuencial) {
        const inputBovedaId = document.getElementById('BovedaId');
        if (inputBovedaId) {
            inputBovedaId.value = id;
            inputBovedaId.dispatchEvent(new Event('change')); // Disparar el evento change si es necesario
        }

        // Cerrar el modal
        const modalElement = document.getElementById('modalBovedas');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
        }
    }
</script>