@model gad_checa_gestion_cementerio.Data.Boveda

@{
    ViewData["Title"] = "Editar Bóveda";
}

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <div class="d-flex align-items-center">
            <i class="fas fa-building me-2"></i>
            <h4 class="card-title mb-0">@ViewData["Title"]</h4>
        </div>
        <p class="mt-2 mb-0">
            Modifique los datos de la bóveda según sea necesario. Los campos marcados con * son obligatorios.
        </p>
    </div>

    <div class="card-body">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form asp-action="Edit" method="post">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="FechaCreacion" />
            <input type="hidden" asp-for="UsuarioCreadorId" />
            <input type="hidden" asp-for="PisoId" />

            <div class="row">
                <!-- Información de la Bóveda -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información de la Bóveda</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Bloque</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-building"></i></span>
                                        <input type="text" class="form-control" value="@ViewBag.BloqueNombre"
                                            readonly />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Piso</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-layer-group"></i></span>
                                        <input type="text" class="form-control" value="@ViewBag.PisoNumero" readonly />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="NumeroSecuecial" class="form-label">Número Secuencial *</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                                        <input asp-for="NumeroSecuecial" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="NumeroSecuecial" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Precio</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                        <input type="text" class="form-control" value="@ViewBag.Precio" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información del Propietario -->
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Propietario</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Buscar Propietario</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <select id="selectPropietario" class="form-select">
                                        <option></option>
                                    </select>
                                    <button type="button" class="btn btn-success" id="btnCrearPropietario"
                                        title="Crear nuevo propietario">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <input type="hidden" asp-for="PropietarioId" id="propietarioId" />
                                <div id="propietarioInfo" class="mt-3 d-none">
                                    <div class="alert alert-info mb-0">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-user me-2 fs-4"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0" id="propietarioNombre"></h6>
                                                    <small class="text-muted" id="propietarioIdentificacion"></small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                    id="btnCambiarPropietario">
                                                    <i class="fas fa-sync-alt me-1"></i>Cambiar
                                                </button>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <small class="text-muted d-block">Teléfono</small>
                                                    <span id="propietarioTelefono" class="fw-bold"></span>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted d-block">Email</small>
                                                    <span id="propietarioEmail" class="fw-bold"></span>
                                                </div>
                                                <div class="col-12 mt-2">
                                                    <small class="text-muted d-block">Dirección</small>
                                                    <span id="propietarioDireccion" class="fw-bold"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Creación de Propietario -->
<div class="modal fade" id="crearPropietarioModal" tabindex="-1" aria-labelledby="crearPropietarioModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="crearPropietarioModalLabel">
                    <i class="fas fa-plus me-2"></i>Crear Nuevo Propietario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPropietario">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombres *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" name="Nombres" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Apellidos *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" name="Apellidos" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Identificación *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                    <select class="form-select" name="TipoIdentificacion" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Cédula">Cédula</option>
                                        <option value="RUC">RUC</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Identificación *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                                    <input type="text" class="form-control" name="NumeroIdentificacion" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Teléfono *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="text" class="form-control" name="Telefono" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" name="Email" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dirección *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                            <input type="text" class="form-control" name="Direccion" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Catastro *</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                            <input type="text" class="form-control" name="Catastro" required>
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnGuardarPropietario">
                            <i class="fas fa-save me-2"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            // Inicializar Select2
            $('#selectPropietario').select2({
                theme: 'bootstrap-5',
                placeholder: 'Buscar por identificación o nombre...',
                allowClear: true,
                ajax: {
                    url: '/Propietario/Buscar',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            searchTerm: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function (item) {
                                return {
                                    id: item.id,
                                    text: `${item.nombres} ${item.apellidos} - ${item.tipoIdentificacion}: ${item.numeroIdentificacion}`,
                                    nombres: item.nombres,
                                    apellidos: item.apellidos,
                                    tipoIdentificacion: item.tipoIdentificacion,
                                    numeroIdentificacion: item.numeroIdentificacion,
                                    telefono: item.telefono,
                                    email: item.email,
                                    direccion: item.direccion
                                };
                            })
                        };
                    },
                    cache: true
                },
                minimumInputLength: 3
            });

            // Inicializar modal
            var crearPropietarioModal = new bootstrap.Modal(document.getElementById('crearPropietarioModal'));

            // Evento al seleccionar un propietario
            $('#selectPropietario').on('select2:select', function (e) {
                var data = e.params.data;
                $('#propietarioId').val(data.id);
                $('#propietarioNombre').text(`${data.nombres} ${data.apellidos}`);
                $('#propietarioIdentificacion').text(`${data.tipoIdentificacion}: ${data.numeroIdentificacion}`);
                $('#propietarioTelefono').text(data.telefono || 'No especificado');
                $('#propietarioEmail').text(data.email || 'No especificado');
                $('#propietarioDireccion').text(data.direccion || 'No especificada');
                $('#propietarioInfo').removeClass('d-none');
            });

            // Evento para abrir modal de creación
            $('#btnCrearPropietario').on('click', function () {
                crearPropietarioModal.show();
            });

            // Evento para cambiar propietario
            $('#btnCambiarPropietario').on('click', function () {
                $('#propietarioId').val('');
                $('#propietarioNombre').text('');
                $('#propietarioIdentificacion').text('');
                $('#propietarioTelefono').text('');
                $('#propietarioEmail').text('');
                $('#propietarioDireccion').text('');
                $('#propietarioInfo').addClass('d-none');
                $('#selectPropietario').val(null).trigger('change');
            });

            // Evento para guardar nuevo propietario
            $('#btnGuardarPropietario').on('click', function () {
                var formData = $('#formPropietario').serialize();
                $.post('/Propietario/GuardarDesdeModal', formData)
                    .done(function (response) {
                        if (response.success) {
                            crearPropietarioModal.hide();

                            // Actualizar el select2 con el nuevo propietario
                            var newOption = new Option(
                                `${response.nombreCompleto} - ${response.tipoIdentificacion}: ${response.numeroIdentificacion}`,
                                response.id,
                                true,
                                true
                            );
                            $('#selectPropietario').append(newOption).trigger('change');

                            // Actualizar la información del propietario
                            $('#propietarioId').val(response.id);
                            $('#propietarioNombre').text(response.nombreCompleto);
                            $('#propietarioIdentificacion').text(`${response.tipoIdentificacion}: ${response.numeroIdentificacion}`);
                            $('#propietarioTelefono').text(response.telefono || 'No especificado');
                            $('#propietarioEmail').text(response.email || 'No especificado');
                            $('#propietarioDireccion').text(response.direccion || 'No especificada');
                            $('#propietarioInfo').removeClass('d-none');
                        } else {
                            alert('Error al guardar el propietario');
                        }
                    })
                    .fail(function () {
                        alert('Error al guardar el propietario');
                    });
            });

            // Cargar propietario actual si existe
            @if (Model.PropietarioId.HasValue)
                {
                    <text>
                        var propietarioId = @Model.PropietarioId.Value;
                        var propietarioNombre = '@Html.Raw(Model.Propietario?.Nombres) @Html.Raw(Model.Propietario?.Apellidos)';
                        var propietarioIdentificacion = '@Html.Raw(Model.Propietario?.TipoIdentificacion): @Model.Propietario?.NumeroIdentificacion';
                        var propietarioTelefono = '@Html.Raw(Model.Propietario?.Telefono)';
                        var propietarioEmail = '@Html.Raw(Model.Propietario?.Email)';
                        var propietarioDireccion = '@Html.Raw(Model.Propietario?.Direccion)';

                        var option = new Option(
                        `${propietarioNombre} - ${propietarioIdentificacion}`,
                                        propietarioId,
                                        true,
                                        true
                                    );
                                    $('#selectPropietario').append(option).trigger('change');
                                    $('#propietarioId').val(propietarioId);
                                    $('#propietarioNombre').text(propietarioNombre);
                                    $('#propietarioIdentificacion').text(propietarioIdentificacion);
                                    $('#propietarioTelefono').text(propietarioTelefono || 'No especificado');
                                    $('#propietarioEmail').text(propietarioEmail || 'No especificado');
                                    $('#propietarioDireccion').text(propietarioDireccion || 'No especificada');
                                    $('#propietarioInfo').removeClass('d-none');
                                </text>
                    }
                });
    </script>
}
