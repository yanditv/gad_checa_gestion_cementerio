@model gad_checa_gestion_cementerio.Data.Boveda

@{
    ViewData["Title"] = "Editar Bóveda";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="ti ti-alert-circle me-2"></i>
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="ti ti-check me-2"></i>
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="ti ti-edit me-2"></i>@ViewData["Title"]
                    </h4>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="FechaCreacion" />
                        <input type="hidden" asp-for="UsuarioCreadorId" />
                        <input type="hidden" asp-for="PisoId" />

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="ti ti-building me-2"></i>Ubicación</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Bloque</label>
                                            <input type="text" class="form-control" value="@ViewBag.BloqueNombre"
                                                readonly />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Piso</label>
                                            <input type="text" class="form-control" value="@ViewBag.PisoNumero"
                                                readonly />
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Número Secuencial</label>
                                            <input type="text" class="form-control" asp-for="NumeroSecuecial"
                                                required />
                                            <span asp-validation-for="NumeroSecuecial" class="text-danger"></span>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Precio</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="text" class="form-control" value="@ViewBag.Precio"
                                                    readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-8">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0"><i class="ti ti-user me-2"></i>Propietario</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Buscar Propietario</label>
                                            <div class="input-group">
                                                <select id="selectPropietario" class="form-select">
                                                    <option></option>
                                                </select>
                                                <button type="button" class="btn btn-success" id="btnCrearPropietario"
                                                    title="Crear nuevo propietario">
                                                    <i class="ti ti-plus"></i>
                                                </button>
                                            </div>
                                            <input type="hidden" asp-for="PropietarioId" id="propietarioId" />
                                            <div id="propietarioInfo" class="mt-3 d-none">
                                                <div class="alert alert-info mb-0">
                                                    <div class="d-flex align-items-center">
                                                        <i class="ti ti-user me-2 fs-4"></i>
                                                        <div class="flex-grow-1">
                                                            <span id="propietarioNombre" class="fw-bold"></span>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-outline-primary"
                                                            id="btnCambiarPropietario">
                                                            <i class="ti ti-refresh me-1"></i>Cambiar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-4">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="ti ti-arrow-left me-1"></i>Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="ti ti-device-floppy me-1"></i>Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Creación de Propietario -->
<div class="modal fade" id="crearPropietarioModal" tabindex="-1" aria-labelledby="crearPropietarioModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="crearPropietarioModalLabel">
                    <i class="ti ti-plus me-2"></i>Crear Nuevo Propietario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPropietario">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombres</label>
                                <input type="text" class="form-control" name="Nombres" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Apellidos</label>
                                <input type="text" class="form-control" name="Apellidos" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Identificación</label>
                                <select class="form-select" name="TipoIdentificacion" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Cédula">Cédula</option>
                                    <option value="RUC">RUC</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Identificación</label>
                                <input type="text" class="form-control" name="NumeroIdentificacion" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="text" class="form-control" name="Telefono" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="Email" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" name="Direccion" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Catastro</label>
                        <input type="text" class="form-control" name="Catastro" required>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="ti ti-x me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnGuardarPropietario">
                            <i class="ti ti-device-floppy me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            // Inicializar Select2
            $('#selectPropietario').select2({
                theme: 'bootstrap-5',
                placeholder: 'Buscar por identificación o nombre...',
                allowClear: true,
                ajax: {
                    url: '/Propietario/Buscar',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            searchTerm: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function (item) {
                                return {
                                    id: item.id,
                                    text: `${item.nombres} ${item.apellidos} - ${item.tipoIdentificacion}: ${item.numeroIdentificacion}`,
                                    nombres: item.nombres,
                                    apellidos: item.apellidos
                                };
                            })
                        };
                    },
                    cache: true
                },
                minimumInputLength: 3
            });

            // Inicializar modal
            var crearPropietarioModal = new bootstrap.Modal(document.getElementById('crearPropietarioModal'));

            // Evento al seleccionar un propietario
            $('#selectPropietario').on('select2:select', function (e) {
                var data = e.params.data;
                $('#propietarioId').val(data.id);
                $('#propietarioNombre').text(`${data.nombres} ${data.apellidos}`);
                $('#propietarioInfo').removeClass('d-none');
            });

            // Evento para abrir modal de creación
            $('#btnCrearPropietario').on('click', function () {
                crearPropietarioModal.show();
            });

            // Evento para cambiar propietario
            $('#btnCambiarPropietario').on('click', function () {
                $('#propietarioId').val('');
                $('#propietarioNombre').text('');
                $('#propietarioInfo').addClass('d-none');
                $('#selectPropietario').val(null).trigger('change');
            });

            // Evento para guardar nuevo propietario
            $('#btnGuardarPropietario').on('click', function () {
                var formData = $('#formPropietario').serialize();
                $.post('/Propietario/GuardarDesdeModal', formData)
                    .done(function (response) {
                        if (response.success) {
                            crearPropietarioModal.hide();

                            // Actualizar el select2 con el nuevo propietario
                            var newOption = new Option(
                                `${response.nombreCompleto} - ${response.tipoIdentificacion}: ${response.numeroIdentificacion}`,
                                response.id,
                                true,
                                true
                            );
                            $('#selectPropietario').append(newOption).trigger('change');

                            // Actualizar la información del propietario
                            $('#propietarioId').val(response.id);
                            $('#propietarioNombre').text(response.nombreCompleto);
                            $('#propietarioInfo').removeClass('d-none');
                        } else {
                            alert('Error al guardar el propietario');
                        }
                    })
                    .fail(function () {
                        alert('Error al guardar el propietario');
                    });
            });

            // Cargar propietario actual si existe
            @if (Model.PropietarioId.HasValue)
                {
                    <text>
                        var propietarioId = @Model.PropietarioId.Value;
                        var propietarioNombre = '@Model.Propietario?.Nombres @Model.Propietario?.Apellidos';
                        var propietarioIdentificacion = '@Model.Propietario?.TipoIdentificacion: @Model.Propietario?.NumeroIdentificacion';

                        var option = new Option(
                        `${propietarioNombre} - ${propietarioIdentificacion}`,
                                                                        propietarioId,
                                                                        true,
                                                                        true
                                                                    );
                                                                    $('#selectPropietario').append(option).trigger('change');
                                                                    $('#propietarioId').val(propietarioId);
                                                                    $('#propietarioNombre').text(propietarioNombre);
                                                                    $('#propietarioInfo').removeClass('d-none');
                                                                </text>
                                    }
                                });
    </script>
}
