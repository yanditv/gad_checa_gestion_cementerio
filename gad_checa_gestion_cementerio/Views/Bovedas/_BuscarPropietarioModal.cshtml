@model gad_checa_gestion_cementerio.Data.Boveda

<!-- Modal de Búsqueda -->
<div class="modal fade" id="buscarPropietarioModal" tabindex="-1" aria-labelledby="buscarPropietarioModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="buscarPropietarioModalLabel">
                    <i class="ti ti-search me-2"></i>Buscar Propietario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Buscar por identificación o nombre</label>
                    <select class="form-select" id="selectPropietario" style="width: 100%;">
                        <option></option>
                    </select>
                </div>
                <div class="text-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnCrearNuevo">
                        <i class="ti ti-plus me-1"></i>Crear Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Creación -->
<div class="modal fade" id="crearPropietarioModal" tabindex="-1" aria-labelledby="crearPropietarioModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="crearPropietarioModalLabel">
                    <i class="ti ti-plus me-2"></i>Crear Nuevo Propietario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPropietario">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nombres</label>
                                <input type="text" class="form-control" name="Nombres" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Apellidos</label>
                                <input type="text" class="form-control" name="Apellidos" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Identificación</label>
                                <select class="form-select" name="TipoIdentificacion" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Cédula">Cédula</option>
                                    <option value="RUC">RUC</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Número de Identificación</label>
                                <input type="text" class="form-control" name="NumeroIdentificacion" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Teléfono</label>
                                <input type="text" class="form-control" name="Telefono" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="Email" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-control" name="Direccion" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Catastro</label>
                        <input type="text" class="form-control" name="Catastro" required>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="ti ti-x me-1"></i>Cancelar
                        </button>
                        <button type="button" class="btn btn-success" id="btnGuardarPropietario">
                            <i class="ti ti-device-floppy me-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Inicializar Select2
            $('#selectPropietario').select2({
                theme: 'bootstrap-5',
                placeholder: 'Buscar por identificación o nombre...',
                allowClear: true,
                ajax: {
                    url: '/Propietario/Buscar',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            searchTerm: params.term
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: data.map(function (item) {
                                return {
                                    id: item.id,
                                    text: `${item.nombres} ${item.apellidos} - ${item.tipoIdentificacion}: ${item.numeroIdentificacion}`,
                                    nombres: item.nombres,
                                    apellidos: item.apellidos
                                };
                            })
                        };
                    },
                    cache: true
                },
                minimumInputLength: 3
            });

            // Inicializar modales
            var buscarPropietarioModal = new bootstrap.Modal(document.getElementById('buscarPropietarioModal'));
            var crearPropietarioModal = new bootstrap.Modal(document.getElementById('crearPropietarioModal'));

            // Evento al seleccionar un propietario
            $('#selectPropietario').on('select2:select', function (e) {
                var data = e.params.data;
                $('#propietarioId').val(data.id);
                $('#propietarioNombre').val(`${data.nombres} ${data.apellidos}`);
                $('#propietarioInfo').removeClass('d-none');
                $('#btnAgregarPropietario').addClass('d-none');
                buscarPropietarioModal.hide();
            });

            // Evento para abrir modal de creación
            $('#btnCrearNuevo').on('click', function () {
                buscarPropietarioModal.hide();
                crearPropietarioModal.show();
            });

            // Evento para guardar nuevo propietario
            $('#btnGuardarPropietario').on('click', function () {
                var formData = $('#formPropietario').serialize();
                $.post('/Propietario/GuardarDesdeModal', formData)
                    .done(function (response) {
                        if (response.success) {
                            crearPropietarioModal.hide();

                            $('#propietarioId').val(response.id);
                            $('#propietarioNombre').val(response.nombreCompleto);
                            $('#propietarioInfo').removeClass('d-none');
                            $('#btnAgregarPropietario').addClass('d-none');
                        } else {
                            alert('Error al guardar el propietario');
                        }
                    })
                    .fail(function () {
                        alert('Error al guardar el propietario');
                    });
            });
        });
    </script>
}